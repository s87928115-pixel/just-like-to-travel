<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS Web App 設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="滑雪不跌倒">
    
    <!-- 圖示設定 -->
    <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>❄️</text></svg>">
    <link rel="apple-touch-icon" id="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>❄️</text></svg>">
    
    <title>滑雪不跌倒 2025</title>
    
    <!-- 載入 React 和 Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 載入樣式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#F9F8F6',
                            card: '#FFFFFF',
                            text: '#333333',
                            primary: '#7F6B5D',
                            accent: '#6B8E23',
                            border: '#E0E0D8'
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F9F8F6;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.1/",
    "react/": "https://esm.sh/react@^19.2.1/",
    "lucide-react": "https://esm.sh/lucide-react@^0.560.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS ---
        const ITINERARY_DATA = [
          { day: 1, date: "2/24 (一)", loc: "東京/輕井澤", weather: ["輕井澤"], items: [
              { time: "06:40", title: "酷航 TR898 出發", desc: "第一航廈報到", type: "transport" },
              { time: "10:45", title: "抵達成田機場", desc: "入境、拿行李", type: "transport" },
              { time: "11:13+", title: "搭車至上野", desc: "車程約50分。班次：11:13, 11:39, 11:59...", type: "transport" },
              { time: "午餐", title: "上野午餐", desc: "推薦：蟹食放題 / 炸豬排 / 天婦羅 (詳見美食頁)", type: "meal" },
              { time: "15:10", title: "新幹線 -> 輕井澤", desc: "從上野站搭新幹線", type: "transport" },
              { time: "16:30", title: "租雪具", desc: "地址：4-8 Karuizawahigashi", map: "4-8 Karuizawahigashi, Karuizawa, Kitasaku District, Nagano 389-0104", type: "activity" },
              { time: "晚餐", title: "輕井澤晚餐", desc: "愛宕 / Access / 村民食堂 / 燒肉 (詳見美食頁)", type: "meal" },
              { time: "住宿", title: "輕井澤王子飯店西館", map: "389-0193 長野縣北佐久郡輕井澤町輕井澤1016-85", type: "hotel" }
          ]},
          { day: 2, date: "2/25 (二)", loc: "輕井澤", weather: ["輕井澤"], items: [
              { time: "全日", title: "滑雪 Day 1", desc: "小心安全，滑雪不跌倒！", type: "activity" }
          ]},
          { day: 3, date: "2/26 (三)", loc: "輕井澤", weather: ["輕井澤"], items: [
              { time: "09:00", title: "滑雪 Day 2", desc: "滑到 16:00 結束", type: "activity" },
              { time: "17:00", title: "租車", desc: "準備自駕行程", type: "transport" }
          ]},
          { day: 4, date: "2/27 (四)", loc: "輕井澤/東京", weather: ["輕井澤", "東京"], items: [
              { time: "09:30", title: "榆樹街小鎮", desc: "逛街、買伴手禮", type: "activity" },
              { time: "11:00", title: "雲場池", desc: "散步拍照", type: "activity" },
              { time: "11:30", title: "舊輕井澤銀座通", desc: "老街逛逛", type: "activity" },
              { time: "13:57+", title: "回上野", desc: "發車：13:57, 15:00, 15:35, 15:56", type: "transport" },
              { time: "晚餐", title: "上野晚餐", desc: "迴轉壽司 / 豬排 (詳見美食頁)", type: "meal" },
              { time: "住宿", title: "LANDABOUT TOKYO", map: "東京都, 東京, Taito-ku Negishi 3-4-5", type: "hotel" }
          ]},
          { day: 5, date: "2/28 (五)", loc: "東京/山形", weather: ["東京", "山形新庄"], items: [
              { time: "09:30", title: "妙義神社", map: "3 Chome-16-16 Komagome, Toshima City, Tokyo", type: "activity" },
              { time: "10:30", title: "池袋太陽城", map: "3 Chome-1 Higashiikebukuro, Toshima City, Tokyo", type: "activity" },
              { time: "13:30", title: "抵達上野車站", desc: "準備移動", type: "transport" },
              { time: "14:00", title: "新幹線 -> 新庄", desc: "前往山形縣", type: "transport" },
              { time: "14:20", title: "阿王阿真去機場", desc: "搭 SKYLINER 回家", type: "transport" },
              { time: "住宿", title: "Route Inn 新莊站前", map: "山形県新庄市金沢沖1109-6", type: "hotel" }
          ]},
          { day: 6, date: "3/1 (六)", loc: "山形/仙台", weather: ["山形新庄", "仙台"], items: [
              { time: "07:50", title: "出門", desc: "早起出發", type: "info" },
              { time: "08:10", title: "陸羽西線 -> 古口", desc: "前往最上川", type: "transport" },
              { time: "09:00", title: "最上川遊船", desc: "欣賞雪景，結束時間約12點", type: "activity" },
              { time: "12:05", title: "交通 Step 1: 回新庄", desc: "【JR陸羽西線 40分】\n1. 高屋 12:05 -> 12:54 到新庄\n2. 古口 12:18 -> 12:54 到新庄\n3. 古口 13:39 -> 14:05 到新庄", type: "transport" },
              { time: "轉乘", title: "交通 Step 2: 新庄->仙台", desc: "【PLAN A: 經福島 (新幹線)】\n1. 13:18 新庄 -> 15:17 福島 (轉) 15:37 -> 17:24 仙台\n2. 15:14 新庄 -> 17:14 福島 (轉) -> 17:46 仙台\n\n【PLAN B: 經山形 (JR+巴士/仙山線)】\n新庄 -> 山形 (JR奧羽本線):\n- 14:19發(15:32到)\n- 16:14發(17:23到)\n山形 -> 仙台:\n- 高速巴士 (約1hr, 半小時一班)\n- JR仙山線: 18:02發 -> 19:32到", type: "transport" },
              { time: "19:30", title: "抵達仙台車站", desc: "集合時間", type: "info" },
              { time: "住宿", title: "The OneFive Sendai", map: "4 Chome-6-28 Tsutsujigaoka, Miyagino Ward, Sendai, Miyagi", type: "hotel" }
  ]},
          { day: 7, date: "3/2 (日)", loc: "仙台/山寺", weather: ["仙台"], items: [
              { time: "Plan A", title: "08:00 出門", desc: "搭乘 08:18 或 09:12 仙山線前往山寺", type: "transport" },
              { time: "Plan A", title: "13:00 午餐", desc: "焰藏 / 山形蕎麦の焔藏 山寺店", type: "meal" },
              { time: "Plan A", title: "14:09 回程", desc: "或搭 15:28 列車回仙台", type: "transport" },
              { time: "Plan B", title: "08:30 仙台朝市", desc: "逛完後 09:30 租車", type: "activity" },
              { time: "Plan B", title: "10:00 採草莓", desc: "一苺一笑 松森農場", map: "Shiromae-157-1 Matsumori, Izumi Ward, Sendai, Miyagi 981-3111", type: "activity" },
              { time: "Plan B", title: "11:30 UJIE 超市", desc: "吉岡店", map: "1-chome-5-8 Yoshiokamahoroba, Taiwa, Kurokawa District, Miyagi 981-3632", type: "activity" },
              { time: "Plan B", title: "13:00 Costco", desc: "好市多 富谷倉庫店", map: "26 Takayashiki, Tomiya, Miyagi 981-3313", type: "activity" },
              { time: "16:00", title: "仙台車站", desc: "會合", type: "info" }
          ]},
          { day: 8, date: "3/3 (一)", loc: "仙台", weather: ["仙台"], items: [
              { time: "08:30", title: "出門", desc: "", type: "info" },
              { time: "09:30", title: "瑞鳳殿", desc: "伊達政宗陵墓", type: "activity" },
              { time: "11:00", title: "大崎八幡宮", desc: "國寶神社", type: "activity" },
              { time: "15:00", title: "租車", desc: "準備前往溫泉", type: "transport" },
              { time: "17:30", title: "仙台車站接人", desc: "", type: "info" },
              { time: "18:30", title: "肉十八", desc: "晚餐：燒肉吃到飽", type: "meal" }
          ]},
          { day: 9, date: "3/4 (二)", loc: "宮城/山形", weather: ["山形市"], items: [
              { time: "09:00", title: "金神水神社", map: "Miyagi, Iwanuma, Miiroyoshi, Suijin−７", type: "activity" },
              { time: "10:30", title: "狐狸村", map: "Miyagi, Shiroishi, 福岡八宮川原子１１−３", desc: "抱狐狸體驗，停留1小時", type: "activity" },
              { time: "12:40", title: "遠刈田溫泉", map: "Togattaonsen Motomachi", type: "activity" },
              { time: "15:15", title: "藏王樹冰", map: "229-3 Zaoonsen, Yamagata", type: "activity" },
              { time: "住宿", title: "Route Inn Yamagataminami", map: "1 Chome-1-11 Iidanishi, Yamagata", type: "hotel" }
          ]},
          { day: 10, date: "3/5 (三)", loc: "山形/宮城", weather: ["尾花澤銀山溫泉", "仙台"], items: [
              { time: "08:30", title: "出門", desc: "早起出發", type: "info" },
              { time: "10:00", title: "大正浪漫館", map: "日本〒999-4332 Yamagata, Obanazawa, Kamiyanagiwatarido, 364 字十分一364-3", type: "activity" },
              { time: "10:30", title: "銀山溫泉", desc: "散步拍照", type: "activity" },
              { time: "12:30", title: "接駁車回程", desc: "準備離開", type: "transport" },
              { time: "14:00", title: "道の駅 おおさき", map: "2 Chome-5-50 Furukawasenjuujicho, Ōsaki, Miyagi 989-6174日本", type: "activity" },
              { time: "15:30", title: "松島海岸", map: "日本〒981-0213 Miyagi, Miyagi District, Matsushima, Namiuchihama−１０ JR松島海岸駅構內", type: "activity" },
              { time: "17:30", title: "三井OUTLET 仙台港", map: "日本〒983-0013 Miyagi, Sendai, Miyagino Ward, Nakano, 3 Chome−７−2", type: "activity" },
              { time: "住宿", title: "The OneFive Sendai", map: "4 Chome-6-28 Tsutsujigaoka, Miyagino Ward, Sendai, Miyagi", type: "hotel" }
          ]},
          { day: 11, date: "3/6 (四)", loc: "仙台/返台", weather: ["仙台"], items: [
              { time: "09:00", title: "出發", desc: "最後一天", type: "info" },
              { time: "11:30", title: "AEON MALL", desc: "最後採買", type: "activity" },
              { time: "14:47", title: "前往仙台機場", desc: "準備登機", type: "transport" },
              { time: "17:25", title: "星宇航空 JX863", desc: "回程", type: "transport" },
              { time: "20:35", title: "抵達台灣", desc: "平安回家", type: "info" }
          ]}
        ];

        const FOOD_DATA = [
          { day: "Day 1 (上野午餐)", items: [
              { name: "蟹食放題 ごっつお", addr: "東京都文京區湯島ライワビル 4F", desc: "★必吃：紅楚蟹吃到飽！蟹肉鮮甜軟嫩，還有螃蟹茶碗蒸、焗烤蟹肉等豐富料理。" },
              { name: "東京炸豬排 がぶう", addr: "東京都台東區上野4-6-4 OGSⅡ B1F", desc: "★推薦：厚切炸豬排。外皮酥脆不油膩，肉質多汁，搭配特製醬汁非常下飯。" },
              { name: "天婦羅 天寿ゞ", addr: "2 Chome-6-7 Ueno, Taito City, Tokyo", desc: "★老店：80年歷史老店。麵衣輕薄酥脆，必點「特上天丼」，有大蝦、穴子魚，醬汁濃郁。" },
              { name: "金沢まいもん寿司", addr: "東京都台東区上野3丁目24-6パルコヤ6階", desc: "★推薦：來自北陸金澤的頂級迴轉壽司。必點「白蝦」、「喉黑魚」，鮮度超群！" }
          ]},
          { day: "Day 1 (輕井澤晚餐)", items: [
              { name: "しゃぶしゃぶ愛宕", addr: "長野県北佐久郡軽井沢町東167", tel: "0267-41-6111", desc: "★高級：A5等級信州牛壽喜燒與涮涮鍋，肉質入口即化，就在車站附近飯店內。" },
              { name: "アクセス-ACCESS", addr: "長野県北佐久郡軽井沢町軽井沢東23-2", tel: "0267-42-3081", desc: "★氣氛：溫馨的洋食餐酒館，適合想吃點義大利麵、披薩或喝杯小酒放鬆。" },
              { name: "村民食堂", addr: "長野県北佐久郡軽井沢町長倉2148", tel: "0267-44-3571", desc: "★人氣：星野區必吃。推薦「信州彩御膳」與「味噌山賊燒」，能吃到當地野菜與特色料理。" },
              { name: "ろぐ亭燒肉", addr: "長野縣北佐久郡輕井澤町長倉3148-1", tel: "0267-45-2341", desc: "★高CP值：小木屋風格燒肉店。提供平價的和牛套餐，也有吃到飽選項，肉質很棒！" }
          ]},
          { day: "Day 4 (上野晚餐)", items: [
              { name: "三浦三崎港迴轉壽司", addr: "東京都台東區上野6-12-14", desc: "★浮誇系：必點「山盛軍艦」系列，鮪魚泥和蟹肉堆得像小山一樣高，CP值爆表。" },
              { name: "ぽん多本家 豬排", addr: "東京都台東区上野3-23-3", desc: "★米其林：必比登推薦名店。使用低溫油炸，豬排呈現粉嫩色澤，口感像牛排一樣軟嫩。" },
              { name: "上野兔屋 銅鑼燒", addr: "東京都台東区上野１丁目１０−10", desc: "★伴手禮：東京三大銅鑼燒之一。紅豆餡綿密，餅皮充滿蜂蜜香氣，建議現買現吃。" },
              { name: "EGG BABY café", addr: "5 Chome-10-9 Ueno, Taito City, Tokyo", desc: "★網美店：招牌「半熟蛋三明治」切面超誘人，還有大人味的焦糖硬布丁也是必點。" },
              { name: "Torie Ueno", addr: "東京都文京区湯島3-40-8 栗田ビル 1F", desc: "★燒鳥：好吃的日式烤雞串專門店，適合作為晚餐後的宵夜場。" }
          ]},
          { day: "Day 5 (新庄/山形)", items: [
              { name: "蕎麥Works蔥房廚 (Negibozu)", addr: "新庄市大手町2-28", tel: "0233-23-3120", desc: "營業時間：11:00～22:00" },
              { name: "Geta Pan (麵包店)", addr: "新庄市鳥越3807-7", tel: "0233-77-4019", desc: "營業時間：8:30-18:30 賣完為止" },
              { name: "竹美堂 (和果子店)", addr: "新庄市沖之町2-28", tel: "0233-22-2297", desc: "營業時間：9:00-19:00" },
              { name: "新旬屋 本店", addr: "山形県新庄市沖の町3-20", tel: "050-5595-9102", desc: "營業時間：16:30～20:30" }
  ]},
          { day: "Day 6 (仙台)", items: [
              { name: "Zunda Saryo 仙台站 (ずんだ茶寮)", addr: "Miyagi, Sendai, Aoba Ward, Central, 1 Chome−1−1 仙台駅3F", desc: "必喝毛豆奶昔！" },
              { name: "牛舌-善治郎 仙台站牛舌通", addr: "Miyagi, Sendai, Aoba Ward, Central, 1 Chome−1−1 ＪＲ仙台駅 3F", desc: "仙台牛舌名店。" },
              { name: "藤原屋 みちのく酒紀行 (地酒)", addr: "Miyagi, Sendai, Aoba Ward, Central, 1 Chome−1−1 エスパル仙台 東館 2F", desc: "S-PAL仙台東館，品嚐東北地酒。" }
          ]},
          { day: "Day 7 (山寺/仙台)", items: [
              { name: "焰藏 / 山形蕎麦の焔藏", addr: "山寺店", desc: "★名物：山寺站旁。必吃「板蕎麥麵」與「鴨肉鍋」，100%使用當地蕎麥粉，香氣十足。" },
              { name: "一苺一笑 松森農場", addr: "Shiromae-157-1 Matsumori, Izumi Ward, Sendai, Miyagi 981-3111", desc: "★體驗：仙台採草莓名所。溫室種植，草莓又大又甜，還有煉乳無限加。" },
              { name: "UJIE 超市 吉岡店", addr: "1-chome-5-8 Yoshiokamahoroba, Taiwa, Kurokawa District, Miyagi 981-3632", desc: "★補給：在地大型超市，適合買水果、飲料和伴手禮。" },
              { name: "好市多 富谷倉庫店", addr: "26 Takayashiki, Tomiya, Miyagi 981-3313", desc: "★採買：Costco Wholesale Tomiya Warehouse。" }
          ]},
          { day: "Day 8 (晚餐)", items: [
              { name: "肉十八", addr: "仙台", desc: "★吃到飽：仙台牛燒肉吃到飽！必攻「厚切牛舌」與「A5和牛」，大口吃肉超滿足。" }
  ]},
          { day: "Day 9 (山形晚餐)", items: [
              { name: "Nanbara Tasuke Sushi (南原 太助寿司)", addr: "Yamagata, Minamiharamachi, 2 Chome−9−12 南原プラザ", desc: "在地壽司店。" },
              { name: "ISLAND PEAK", addr: "1 Chome-7-24 Honcho, Yamagata, 990-0043", desc: "International Café & Bar。營業時間：11:30–14:30, 18:30–00:00" }
  ]},
          { day: "Day 10 (銀山溫泉)", items: [
              { name: "蕎麥麵 滝見館", addr: "522 Ginzanshinhata, Obanazawa, Yamagata 999-4333日本", desc: "銀山溫泉美食" },
              { name: "伊豆之華", addr: "440 Ginzanshinhata, Obanazawa, Yamagata 999-4333日本", desc: "銀山溫泉美食" }
          ]}
        ];

        const PACKING_LIST = [
          {
            title: "個人物品",
            items: ["護照", "信用卡", "身分證", "現金", "身分證影本", "護照影本", "駕照", "國際駕照", "駕照譯本"]
          },
          {
            title: "雜物",
            items: ["衣物", "帽子", "太陽眼鏡", "隱眼", "梳子", "保養品(乳液、護手霜、洗臉的)", "藥品(感冒、暈車、過敏、腸胃)"]
          },
          {
            title: "電子產品",
            items: ["充電器", "充電線", "行動電源", "萬國插座", "GoPro/相機", "GoPro/相機充電器", "電池", "記憶卡", "網卡", "SIM卡針"]
          },
          {
            title: "滑雪行前準備",
            items: ["雪鏡", "排汗衣", "保暖長袖", "手套", "長襪", "不會滑倒的鞋子", "屁墊", "暖暖包", "護膝", "護手", "冰爪"]
          },
          {
            title: "滑雪租借",
            items: ["滑雪衣", "滑雪褲", "安全帽", "雪板", "雪鏡 (租借)"]
          }
        ];

        const HOTEL_LIST = [
          {
            name: "輕井澤王子飯店西館",
            address: "389-0193 長野縣北佐久郡輕井澤町輕井澤1016-85",
            note: "Day 1-3 住宿"
          },
          {
            name: "LANDABOUT TOKYO",
            address: "東京都, 東京, Taito-ku Negishi 3-4-5",
            note: "Day 4 住宿"
          },
          {
            name: "Route Inn 新莊站前",
            address: "山形県新庄市金沢沖1109-6",
            note: "Day 5 住宿"
          },
          {
            name: "The OneFive Sendai",
            address: "4 Chome-6-28 Tsutsujigaoka, Miyagino Ward, Sendai, Miyagi",
            note: "Day 6-8, Day 10 住宿"
          },
          {
            name: "Route Inn Yamagataminami",
            address: "1 Chome-1-11 Iidanishi, Yamagata",
            note: "Day 9 住宿"
          }
        ];

        // --- UTILS ---
        const formatMoney = (num) => new Intl.NumberFormat('en-US').format(num);
        const getMapLink = (query) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
        const processImage = (file, callback) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              const MAX_WIDTH = 600;
              const scale = MAX_WIDTH / img.width;
              canvas.width = MAX_WIDTH;
              canvas.height = img.height * scale;
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              callback(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        };
        const safeCalculate = (expression) => {
            try {
                if (/^[0-9+\-*/().\s]+$/.test(expression)) {
                    return new Function('return ' + expression)();
                }
                return null;
            } catch (e) { return null; }
        };
        const linkifyText = (text) => {
           return text.split(/(https?:\/\/[^\s]+)/g);
        };

        // --- COMPONENTS ---

        // PLAN VIEW
        const PlanView = ({ coverImg, onUpdateCover }) => {
          const [currentDay, setCurrentDay] = useState(1);

          const handleDayClick = (day) => {
             setCurrentDay(day);
             window.scrollTo({top: 0, behavior: 'smooth'});
          };

          const handleCoverUpload = (e) => {
              const file = e.target.files?.[0];
              if(file) processImage(file, (base64) => {
                  onUpdateCover(base64);
              });
          };

          const removeCover = (e) => {
              e.stopPropagation();
              if(confirm('確定移除封面?')) {
                  onUpdateCover(null);
              }
          }

          const selectedDayData = ITINERARY_DATA.find(d => d.day === currentDay);
          const showFlightCard = currentDay === 1 || currentDay === 11;
          const getWeatherLink = (query) => `https://www.google.com/search?q=weather+${query}`;

          return (
            <div className="pt-[130px] pb-24 px-4 animate-fade-in">
              <div className="fixed top-[70px] left-0 w-full bg-[#F9F8F6]/95 z-40 overflow-x-auto no-scrollbar py-3 px-2 border-b border-muji-border flex items-center shadow-sm">
                {ITINERARY_DATA.map((day) => {
                  const isActive = currentDay === day.day;
                  return (
                    <button 
                        key={day.day} 
                        onClick={() => handleDayClick(day.day)} 
                        className={`whitespace-nowrap px-5 py-2 rounded-full border transition-all shadow-sm flex-shrink-0 mr-3 ${isActive ? 'bg-muji-primary text-white border-muji-primary font-bold' : 'bg-white border-muji-border text-gray-600 hover:bg-gray-50'}`}
                    >
                        Day {day.day}
                    </button>
                  );
                })}
              </div>

              {/* Cover Image */}
              <div className="relative mb-6">
                {coverImg ? (
                    <div className="relative group">
                        <img src={coverImg} className="w-full h-48 sm:h-64 object-cover rounded-2xl shadow-md border border-gray-100" />
                        <button onClick={removeCover} className="absolute top-3 right-3 bg-black/50 text-white p-2 rounded-full backdrop-blur-md shadow-sm">
                            <i className="fa-solid fa-xmark"></i>
                        </button>
                        <label className="absolute bottom-3 right-3 bg-white/90 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm backdrop-blur-md cursor-pointer flex items-center gap-2">
                            <i className="fa-solid fa-camera"></i> 更換封面
                            <input type="file" accept="image/*" className="hidden" onChange={handleCoverUpload} />
                        </label>
                    </div>
                ) : (
                    <label className="w-full h-40 bg-white border-2 border-dashed border-gray-300 rounded-2xl flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-50 hover:border-muji-primary hover:text-muji-primary transition-all">
                        <i className="fa-regular fa-image text-3xl mb-2"></i>
                        <span className="font-bold text-sm">點擊設定封面照片</span>
                        <input type="file" accept="image/*" className="hidden" onChange={handleCoverUpload} />
                    </label>
                )}
              </div>

              {/* Flight Card - Only on Day 1 & 11 */}
              {showFlightCard && (
                <div className="bg-muji-primary text-white rounded-2xl p-5 relative overflow-hidden shadow-md mb-8 animate-fade-in">
                    <div className="absolute -right-4 -top-4 text-white/10 text-8xl"><i className="fa-solid fa-plane"></i></div>
                    <h3 className="font-bold text-xl mb-3 relative z-10">航班資訊</h3>
                    <div className="relative z-10 space-y-3">
                    <div className={`flex justify-between items-center p-2 rounded-lg ${currentDay === 1 ? 'bg-white/10' : ''}`}>
                        <div>
                            <div className="text-sm opacity-80">2/24 去程 (酷航 TR898)</div>
                            <div className="text-2xl font-bold">06:40 <i className="fa-solid fa-arrow-right text-sm mx-1"></i> 10:45</div>
                        </div>
                    </div>
                    <div className={`border-t border-white/20 pt-3 p-2 rounded-lg ${currentDay === 11 ? 'bg-white/10' : ''}`}>
                        <div className="text-sm opacity-80">3/6 回程 (星宇 JX863)</div>
                        <div className="text-2xl font-bold">17:25 <i className="fa-solid fa-arrow-right text-sm mx-1"></i> 20:35</div>
                    </div>
                    </div>
                </div>
              )}

              {/* Selected Day Content */}
              {selectedDayData && (
                <div className="animate-fade-in min-h-[50vh]">
                  <div className="flex flex-col gap-2 mb-4 py-2 border-b-2 border-gray-200">
                    <div className="flex items-baseline">
                        <span className="text-3xl font-bold text-muji-primary mr-3">DAY {selectedDayData.day}</span>
                        <span className="text-lg text-gray-500">{selectedDayData.date}</span>
                    </div>
                    <div className="flex items-center gap-2 overflow-x-auto no-scrollbar mt-1">
                        <span className="text-xs bg-muji-accent text-white px-3 py-1 rounded-full whitespace-nowrap">{selectedDayData.loc}</span>
                        {selectedDayData.weather.map((loc, idx) => (
                            <a 
                                key={idx}
                                href={getWeatherLink(loc)}
                                target="_blank"
                                rel="noreferrer"
                                className="text-xs bg-blue-50 text-blue-600 border border-blue-100 px-3 py-1 rounded-full whitespace-nowrap flex items-center gap-1 hover:bg-blue-100 transition-colors"
                            >
                                <i className="fa-solid fa-cloud-sun text-xs"></i> {loc}天氣
                            </a>
                        ))}
                    </div>
                  </div>
                  <div className="border-l-4 border-muji-border ml-3 space-y-6 pb-2">
                    {selectedDayData.items.map((item, idx) => (
                      <div key={idx} className="relative pl-8">
                        <div className="absolute -left-[11px] top-2 w-5 h-5 rounded-full bg-[#F9F8F6] border-4 border-muji-accent z-10"></div>
                        <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 relative">
                            {item.map && <a href={getMapLink(item.map)} target="_blank" className="absolute top-4 right-4 text-muji-primary w-10 h-10 flex items-center justify-center bg-gray-50 rounded-full shadow-sm"><i className="fa-solid fa-location-dot"></i></a>}
                            <div className="text-muji-accent font-bold text-lg mb-1">{item.time}</div>
                            <div className="font-bold text-xl text-muji-text mb-2 pr-10">{item.title}</div>
                            {item.desc && <div className="text-base text-gray-600 leading-relaxed whitespace-pre-line">{item.desc}</div>}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          );
        };

        // FOOD VIEW
        const FoodView = () => {
          const [customFood, setCustomFood] = useState([]);
          const [showModal, setShowModal] = useState(false);
          const [newFood, setNewFood] = useState({name:'', addr:'', desc:''});

          useEffect(() => {
              const saved = localStorage.getItem('customFood');
              if(saved) setCustomFood(JSON.parse(saved));
          }, []);

          const addCustomFood = () => {
              if(!newFood.name) return;
              const updated = [...customFood, newFood];
              setCustomFood(updated);
              localStorage.setItem('customFood', JSON.stringify(updated));
              setNewFood({name:'', addr:'', desc:''});
              setShowModal(false);
          };

          const allSections = [...(customFood.length > 0 ? [{day: "自訂新增", items: customFood}] : []), ...FOOD_DATA];

          return (
            <div className="pt-24 pb-24 px-4 animate-fade-in">
              <div className="text-center mb-8">
                <h2 className="text-3xl font-serif text-muji-primary font-bold">必吃美食導覽</h2>
                <p className="text-sm text-gray-500 mt-1">Gourmet Guide</p>
              </div>
              <div className="grid gap-8">
                 {allSections.map((section, idx) => (
                    <div key={idx}>
                        <div className="bg-muji-primary text-white py-2 px-5 rounded-lg font-bold text-lg mb-4 inline-block shadow-sm">{section.day}</div>
                        <div className="grid gap-4">
                            {section.items.map((item, i) => (
                                <div key={i} className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 relative">
                                    <a href={getMapLink(item.addr)} target="_blank" className="absolute top-5 right-5 w-12 h-12 bg-[#F9F8F6] rounded-full flex items-center justify-center text-muji-primary shadow-sm border border-gray-200"><i className="fa-solid fa-location-arrow"></i></a>
                                    <h4 className="font-bold text-xl mb-2 text-muji-text pr-14">{item.name}</h4>
                                    <p className="text-base text-gray-500 mb-2"><i className="fa-solid fa-map-pin mr-2 text-muji-primary"></i>{item.addr}</p>
                                    {item.tel && <p className="text-base text-gray-500 mb-3"><i className="fa-solid fa-phone mr-2 text-muji-primary"></i>{item.tel}</p>}
                                    {item.desc && <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 text-base text-gray-700 leading-relaxed"><i className="fa-solid fa-thumbs-up text-orange-400 mr-2"></i>{item.desc}</div>}
                                </div>
                            ))}
                        </div>
                    </div>
                 ))}
              </div>
              <button onClick={() => setShowModal(true)} className="fixed bottom-24 right-5 bg-muji-primary text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-2xl z-30 active:scale-95 transition-transform"><i className="fa-solid fa-plus"></i></button>

              {showModal && (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                  <div className="bg-white rounded-2xl w-full max-sm p-6 shadow-2xl">
                    <h3 className="font-bold text-xl mb-4 text-center">新增餐廳</h3>
                    <input className="w-full border-2 border-gray-200 rounded-lg p-3 mb-3 text-lg" placeholder="餐廳名稱" value={newFood.name} onChange={e => setNewFood({...newFood, name: e.target.value})} />
                    <input className="w-full border-2 border-gray-200 rounded-lg p-3 mb-3 text-lg" placeholder="地址" value={newFood.addr} onChange={e => setNewFood({...newFood, addr: e.target.value})} />
                    <textarea className="w-full border-2 border-gray-200 rounded-lg p-3 mb-5 text-lg h-24 resize-none" placeholder="備註..." value={newFood.desc} onChange={e => setNewFood({...newFood, desc: e.target.value})} />
                    <div className="flex justify-end gap-3">
                        <button onClick={() => setShowModal(false)} className="px-6 py-3 rounded-lg text-gray-500 font-bold border border-gray-300">取消</button>
                        <button onClick={addCustomFood} className="bg-muji-primary text-white px-6 py-3 rounded-lg font-bold shadow-md">儲存</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // WALLET VIEW
        const WalletView = () => {
          const [rate, setRate] = useState(0.22);
          const [calcInput, setCalcInput] = useState('');
          const [calcResult, setCalcResult] = useState('');
          const [records, setRecords] = useState([]);
          const [form, setForm] = useState({item: '', amount: '', img: null});
          const [editingId, setEditingId] = useState(null);
          const [previewImg, setPreviewImg] = useState(null);

          useEffect(() => {
              const r = localStorage.getItem('walletRate');
              if(r) setRate(parseFloat(r));
              const rec = localStorage.getItem('walletRecords');
              if(rec) setRecords(JSON.parse(rec));
          }, []);

          const handleRate = (v) => {
              setRate(parseFloat(v));
              localStorage.setItem('walletRate', v);
          };

          const calculate = () => {
              const res = safeCalculate(calcInput);
              if(res !== null) setCalcResult(`¥${res} ≈ NT$${Math.round(res * rate)}`);
              else setCalcResult('格式錯誤');
          };

          const handleSave = () => {
              if(!form.item || !form.amount) return alert('請輸入完整資訊');
              
              if (editingId) {
                  const updated = records.map(r => 
                      r.id === editingId ? {...r, item: form.item, amount: parseFloat(form.amount), img: form.img} : r
                  );
                  setRecords(updated);
                  localStorage.setItem('walletRecords', JSON.stringify(updated));
                  setEditingId(null);
              } else {
                  const newRec = { 
                      id: Date.now().toString(), 
                      item: form.item, 
                      amount: parseFloat(form.amount), 
                      date: new Date().toISOString(),
                      img: form.img
                  };
                  const updated = [...records, newRec];
                  setRecords(updated);
                  localStorage.setItem('walletRecords', JSON.stringify(updated));
              }
              setForm({item:'', amount:'', img: null});
          };

          const startEdit = (rec) => {
              setForm({item: rec.item, amount: rec.amount, img: rec.img});
              setEditingId(rec.id);
              window.scrollTo({top:0, behavior:'smooth'});
          };

          const cancelEdit = () => {
              setForm({item:'', amount:'', img: null});
              setEditingId(null);
          };

          const deleteRecord = (id) => {
              if(!confirm('確定刪除?')) return;
              const updated = records.filter(r => r.id !== id);
              setRecords(updated);
              localStorage.setItem('walletRecords', JSON.stringify(updated));
              if(editingId === id) cancelEdit();
          };

          const totalYen = records.reduce((acc, cur) => acc + cur.amount, 0);

          return (
             <div className="pt-24 pb-24 px-4 space-y-6 animate-fade-in">
                <div className="bg-[#F9F8F6] border border-muji-primary/20 p-5 rounded-2xl flex justify-between items-center shadow-sm">
                    <span className="text-lg font-bold text-muji-primary">目前匯率</span>
                    <div className="flex items-center gap-3">
                        <span className="text-gray-500">1 JPY =</span>
                        <input type="number" value={rate} onChange={e=>handleRate(e.target.value)} className="w-20 border-2 rounded-lg text-center p-2 text-lg font-bold" />
                        <span className="text-gray-500">TWD</span>
                    </div>
                </div>

                <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <label className="text-sm font-bold text-gray-400 mb-2 block">快速試算</label>
                    <div className="flex gap-3 mb-3">
                        <input value={calcInput} onChange={e=>setCalcInput(e.target.value)} placeholder="輸入日幣..." className="flex-1 border-b-2 border-muji-primary/50 text-2xl py-2 font-mono outline-none" />
                        <button onClick={calculate} className="bg-muji-primary text-white rounded-xl w-12 h-12 flex items-center justify-center"><i className="fa-solid fa-calculator"></i></button>
                    </div>
                    <div className="text-right h-8 text-xl text-muji-accent font-bold">{calcResult}</div>
                </div>

                <div className={`bg-white rounded-2xl p-6 shadow-sm border transition-colors ${editingId ? 'border-muji-accent border-2' : 'border-gray-100'}`}>
                    <h3 className={`font-bold text-xl mb-5 ${editingId ? 'text-muji-accent' : 'text-muji-primary'}`}>
                        {editingId ? <><i className="fa-solid fa-pen mr-2"></i>修改記帳</> : <><i className="fa-solid fa-pen-to-square mr-2"></i>新增記帳</>}
                    </h3>
                    <input value={form.item} onChange={e=>setForm({...form, item:e.target.value})} placeholder="品項名稱" className="w-full border-2 border-gray-200 rounded-lg p-3 mb-3 text-lg" />
                    <input type="number" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} placeholder="日幣金額" className="w-full border-2 border-gray-200 rounded-lg p-3 mb-4 text-lg" />
                    <div className="flex gap-3 mb-5">
                        <label className="flex-1 cursor-pointer bg-gray-50 text-gray-600 py-3 rounded-lg text-center border-2 border-dashed border-gray-300 hover:bg-gray-100 flex items-center justify-center gap-2">
                            <i className="fa-solid fa-camera"></i> {form.img ? '更換照片' : '拍照存證'}
                            <input type="file" accept="image/*" className="hidden" onChange={e => {
                                if(e.target.files[0]) processImage(e.target.files[0], b64 => setForm({...form, img: b64}));
                            }} />
                        </label>
                    </div>
                    {form.img && (
                        <div className="mb-5 relative inline-block">
                            <img src={form.img} className="h-32 rounded-lg object-cover border-2 border-gray-200" />
                            <button onClick={()=>setForm({...form, img:null})} className="absolute -top-3 -right-3 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-md"><i className="fa-solid fa-xmark"></i></button>
                        </div>
                    )}
                    <div className="flex gap-3">
                        {editingId && (
                            <button onClick={cancelEdit} className="flex-1 bg-gray-200 text-gray-600 rounded-xl py-3 text-lg font-bold shadow-sm">取消</button>
                        )}
                        <button onClick={handleSave} className={`flex-[2] text-white rounded-xl py-3 text-lg font-bold shadow-md ${editingId ? 'bg-muji-accent' : 'bg-muji-primary'}`}>{editingId ? '儲存修改' : '記一筆'}</button>
                    </div>
                </div>

                <div>
                    <h3 className="font-bold text-2xl mb-4 pl-3 border-l-4 border-muji-primary">消費紀錄</h3>
                    {records.length === 0 ? (
                        <div className="text-center text-gray-400 py-10 text-lg">目前還沒有亂花錢喔！</div>
                    ) : (
                        <div className="rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
                            {[...records].reverse().map((rec, idx) => (
                                <div key={rec.id} className={`p-4 flex items-center gap-3 border-b border-gray-100 last:border-0 ${editingId === rec.id ? 'bg-blue-50' : (idx % 2 === 0 ? 'bg-white' : 'bg-[#FAF9F6]')}`}>
                                    {rec.img ? <img src={rec.img} className="w-14 h-14 rounded-lg object-cover border border-gray-200 bg-white shrink-0" onClick={()=>setPreviewImg(rec.img)}/> : <div className="w-14 h-14 rounded-lg bg-white border border-gray-100 flex items-center justify-center text-gray-300 shrink-0"><i className="fa-solid fa-bag-shopping fa-lg"></i></div>}
                                    <div className="flex-1 min-w-0">
                                        <div className="font-bold text-lg truncate text-gray-800">{rec.item}</div>
                                        <div className="text-xs text-gray-400 mt-0.5">{new Date(rec.date).toLocaleDateString()}</div>
                                    </div>
                                    <div className="text-right shrink-0">
                                        <div className="font-bold font-mono text-lg">¥{formatMoney(rec.amount)}</div>
                                        <div className="text-xs text-muji-accent font-bold">≈ NT${formatMoney(Math.round(rec.amount * rate))}</div>
                                    </div>
                                    <div className="flex gap-1 ml-1">
                                        <button onClick={()=>startEdit(rec)} className="text-gray-400 p-2 hover:text-muji-primary hover:bg-gray-100 rounded-lg transition-colors"><i className="fa-solid fa-pen"></i></button>
                                        <button onClick={()=>deleteRecord(rec.id)} className="text-gray-400 p-2 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><i className="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                <div className="bg-muji-primary text-white rounded-2xl p-5 flex justify-between items-center shadow-lg mt-8">
                    <span className="text-lg font-bold">總支出</span>
                    <div className="text-right">
                        <div className="text-2xl font-bold">¥{formatMoney(totalYen)}</div>
                        <div className="text-base opacity-90">≈ NT${formatMoney(Math.round(totalYen * rate))}</div>
                    </div>
                </div>
                
                {previewImg && <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4 animate-fade-in" onClick={()=>setPreviewImg(null)}><img src={previewImg} className="max-w-full max-h-full rounded-lg shadow-2xl"/></div>}
             </div>
          );
        };

        // LISTS VIEW
        const ListsView = () => {
            const [tab, setTab] = useState('pack');
            const [checks, setChecks] = useState({});
            const [memo, setMemo] = useState('');
            const [shop, setShop] = useState([]);
            const [shopInput, setShopInput] = useState({text:'', img: null});
            const [fullImg, setFullImg] = useState(null);
            
            const [expandedSections, setExpandedSections] = useState(() => {
                const initial = {};
                PACKING_LIST.forEach(c => initial[c.title] = true);
                return initial;
            });

            // Tracking inline previews
            const [expandedPreviews, setExpandedPreviews] = useState(new Set());

            useEffect(() => {
                const c = localStorage.getItem('checkListState');
                if(c) setChecks(JSON.parse(c));
                const m = localStorage.getItem('memoText');
                if(m) setMemo(m);
                const s = localStorage.getItem('shopList');
                if(s) setShop(JSON.parse(s));
            }, []);

            const toggleCheck = (item) => {
                const n = {...checks, [item]: !checks[item]};
                setChecks(n);
                localStorage.setItem('checkListState', JSON.stringify(n));
            };

            const toggleSection = (title) => {
                setExpandedSections(prev => ({ ...prev, [title]: !prev[title] }));
            };

            const toggleUrlPreview = (url) => {
                const newSet = new Set(expandedPreviews);
                if (newSet.has(url)) newSet.delete(url);
                else newSet.add(url);
                setExpandedPreviews(newSet);
            };

            const addShop = () => {
                if(!shopInput.text && !shopInput.img) return;
                const n = [...shop, {id: Date.now(), ...shopInput, done: false}];
                setShop(n);
                localStorage.setItem('shopList', JSON.stringify(n));
                setShopInput({text:'', img: null});
            };

            const toggleShop = (id) => {
                const n = shop.map(i => i.id === id ? {...i, done: !i.done} : i);
                setShop(n);
                localStorage.setItem('shopList', JSON.stringify(n));
            };
            
            const deleteShop = (id) => {
                if(!confirm('確定刪除這個項目嗎？')) return;
                const n = shop.filter(i => i.id !== id);
                setShop(n);
                localStorage.setItem('shopList', JSON.stringify(n));
            };

            const renderTextWithPreviews = (text, isDone = false) => {
                const parts = linkifyText(text);
                return (
                    <div className="space-y-3">
                        <div>
                            {parts.map((part, i) => {
                                if (part.match(/^https?:\/\//)) {
                                    const isExp = expandedPreviews.has(part);
                                    return (
                                        <span key={i} className="inline-flex items-center gap-1 mx-1 align-middle">
                                            <a href={part} target="_blank" rel="noreferrer" className={`text-blue-500 underline inline-flex items-center gap-1 ${isDone ? 'opacity-50' : ''}`}>
                                                <i className="fa-solid fa-link"></i>連結
                                            </a>
                                            <button onClick={() => toggleUrlPreview(part)} className={`w-7 h-7 flex items-center justify-center rounded-md transition-all ${isExp ? 'bg-muji-primary text-white shadow-inner' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}`}>
                                                <i className={`fa-solid ${isExp ? 'fa-eye-slash' : 'fa-eye'} text-xs`}></i>
                                            </button>
                                        </span>
                                    );
                                }
                                return part;
                            })}
                        </div>
                        {parts.filter(p => p.match(/^https?:\/\//) && expandedPreviews.has(p)).map((url, idx) => (
                            <div key={idx} className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-md mt-2 animate-fade-in ring-4 ring-gray-100/50">
                                <div className="bg-muji-bg px-3 py-1.5 flex justify-between items-center border-b border-gray-100">
                                    <span className="text-[10px] text-gray-400 font-mono truncate max-w-[60%]">{url}</span>
                                    <a href={url} target="_blank" rel="noreferrer" className="text-[10px] text-muji-primary font-bold flex items-center gap-1 bg-white px-2 py-0.5 rounded border border-gray-200 active:scale-95"><i className="fa-solid fa-arrow-up-right-from-square"></i> 開啟頁面</a>
                                </div>
                                <iframe src={url} className="w-full h-56 border-0 bg-white" sandbox="allow-scripts allow-same-origin"></iframe>
                                <div className="p-2 bg-gray-50 text-[10px] text-center text-gray-400 italic">若網頁無法載入（顯示拒絕連線），代表該網站安全設定禁止嵌入，請點選上方「開啟頁面」。</div>
                            </div>
                        ))}
                    </div>
                );
            };

            const renderShopItem = (item) => (
                <div key={item.id} className={`bg-white rounded-2xl p-4 flex gap-4 items-start shadow-sm border transition-all ${item.done ? 'border-gray-100 bg-gray-50/50' : 'border-gray-100'}`}>
                    <div className="pt-2">
                        <button 
                            onClick={()=>toggleShop(item.id)}
                            className={`w-6 h-6 rounded-md border-2 flex items-center justify-center transition-colors ${item.done ? 'bg-muji-accent border-muji-accent' : 'border-gray-300 bg-white'}`}
                        >
                            {item.done && <i className="fa-solid fa-check text-white text-xs"></i>}
                        </button>
                    </div>
                    {item.img && (
                        <img 
                            src={item.img} 
                            className={`w-20 h-20 object-cover rounded-lg shrink-0 border border-gray-100 cursor-pointer ${item.done ? 'opacity-50 grayscale' : ''}`}
                            onClick={()=>setFullImg(item.img)} 
                        />
                    )}
                    <div className="flex-1 min-w-0 pt-1">
                        <div className={`text-xl font-medium break-all ${item.done ? 'text-gray-400' : 'text-gray-800'}`}>
                           {renderTextWithPreviews(item.text, item.done)}
                        </div>
                    </div>
                    <button onClick={()=>deleteShop(item.id)} className="text-gray-300 p-2 hover:text-red-400"><i className="fa-solid fa-xmark text-xl"></i></button>
                </div>
            );

            return (
                <div className="pt-24 pb-24 px-4 animate-fade-in">
                    <div className="flex border-b-2 border-gray-200 mb-6">
                        {['pack:必備', 'memo:備忘', 'shop:購物'].map(t => {
                            const [k, v] = t.split(':');
                            return <button key={k} onClick={()=>setTab(k)} className={`flex-1 py-3 text-center font-bold text-xl ${tab===k ? 'text-muji-primary border-b-4 border-muji-primary' : 'text-gray-400 border-transparent'}`}>{v}</button>;
                        })}
                    </div>

                    {tab === 'pack' && (
                        <div className="space-y-4 animate-fade-in">
                            {PACKING_LIST.map((category) => {
                                const isExpanded = expandedSections[category.title];
                                const completedCount = category.items.filter(i => checks[i]).length;
                                return (
                                  <div key={category.title} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 overflow-hidden transition-all">
                                    <div 
                                        className="flex items-center justify-between cursor-pointer"
                                        onClick={() => toggleSection(category.title)}
                                    >
                                        <div className="flex items-center gap-3">
                                            <h3 className="font-bold text-lg text-muji-primary">
                                              {category.title}
                                            </h3>
                                            <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full font-mono">
                                                {completedCount}/{category.items.length}
                                            </span>
                                        </div>
                                        <div className="text-gray-400 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-50">
                                            <i className={`fa-solid ${isExpanded ? 'fa-chevron-up' : 'fa-chevron-down'}`}></i>
                                        </div>
                                    </div>
                                    {isExpanded && (
                                        <div className="grid grid-cols-1 gap-3 mt-3 border-t border-gray-100 pt-3 animate-fade-in">
                                          {category.items.map((item) => (
                                            <label key={item} className={`cursor-pointer rounded-lg p-3 flex items-center gap-3 transition-all duration-200 active:scale-98 ${checks[item] ? 'bg-muji-primary/10 text-muji-primary' : 'hover:bg-gray-50 text-gray-700'}`}>
                                              <div className="relative flex items-center justify-center">
                                                <input type="checkbox" className="peer appearance-none w-6 h-6 border-2 border-gray-300 rounded-md checked:bg-muji-primary checked:border-muji-primary transition-colors" checked={!!checks[item]} onChange={()=>toggleCheck(item)} />
                                                <i className="fa-solid fa-check absolute text-white pointer-events-none opacity-0 peer-checked:opacity-100 transition-opacity text-sm"></i>
                                              </div>
                                              <span className={`text-lg font-medium ${checks[item] ? 'line-through opacity-70' : ''}`}>{item}</span>
                                            </label>
                                          ))}
                                        </div>
                                    )}
                                  </div>
                                );
                            })}
                        </div>
                    )}

                    {tab === 'memo' && (
                        <div className="space-y-4">
                            <textarea value={memo} onChange={e=>{setMemo(e.target.value); localStorage.setItem('memoText', e.target.value)}} className="w-full h-80 p-5 rounded-xl border-2 border-gray-200 text-lg resize-none" placeholder="隨手記點什麼..." />
                            <div className="p-5 bg-white rounded-xl border border-gray-200 shadow-sm">
                                <h4 className="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">內容預覽</h4>
                                {renderTextWithPreviews(memo)}
                            </div>
                        </div>
                    )}

                    {tab === 'shop' && (
                        <div className="space-y-6">
                            <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                                <div className="flex gap-3 mb-3">
                                    <input value={shopInput.text} onChange={e=>setShopInput({...shopInput, text:e.target.value})} placeholder="想買什麼？" className="flex-1 border-2 border-gray-200 rounded-lg p-3 text-lg" />
                                    <label className="bg-gray-100 px-4 py-3 rounded-lg cursor-pointer border-2 border-gray-100 hover:bg-gray-200 flex items-center"><i className="fa-solid fa-camera text-gray-500 text-xl"></i><input type="file" accept="image/*" className="hidden" onChange={e=>{if(e.target.files[0]) processImage(e.target.files[0], b64=>setShopInput({...shopInput, img: b64}))}} /></label>
                                </div>
                                {shopInput.img && (
                                  <div className="mb-4 relative">
                                    <img src={shopInput.img} className="w-full h-auto max-h-64 object-contain rounded-lg border border-gray-200 bg-gray-50" />
                                    <button onClick={()=>setShopInput({...shopInput, img:null})} className="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-md"><i className="fa-solid fa-xmark"></i></button>
                                  </div>
                                )}
                                <button onClick={addShop} className="w-full bg-muji-primary text-white rounded-xl py-3 text-lg font-bold shadow-md">加入清單</button>
                            </div>
                            <div className="space-y-4">
                                {shop.length === 0 && (
                                    <div className="text-center text-gray-400 text-lg py-10 flex flex-col items-center gap-2">
                                        <i className="fa-solid fa-cart-shopping text-4xl text-gray-200"></i>
                                        購物車空空的
                                    </div>
                                )}
                                {shop.filter(i => !i.done).reverse().map(renderShopItem)}
                                {shop.filter(i => i.done).length > 0 && (
                                    <>
                                        <div className="flex items-center gap-3 py-2 mt-6">
                                            <div className="h-px bg-gray-200 flex-1"></div>
                                            <span className="text-sm font-bold text-gray-400 flex items-center gap-1">
                                                <i className="fa-solid fa-circle-check"></i> 已購買 ({shop.filter(i => i.done).length})
                                            </span>
                                            <div className="h-px bg-gray-200 flex-1"></div>
                                        </div>
                                        {shop.filter(i => i.done).reverse().map(renderShopItem)}
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                    {fullImg && <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 animate-fade-in" onClick={()=>setFullImg(null)}><img src={fullImg} className="max-w-full max-h-full rounded-lg shadow-2xl"/></div>}
                </div>
            );
        };

        // INFO VIEW
        const InfoView = () => {
          const [qrCode, setQrCode] = useState(null);
          const [fullImg, setFullImg] = useState(null);
          
          const [carRental, setCarRental] = useState({ img: null, address: '' });
          const [isEditingCar, setIsEditingCar] = useState(false);
          const [tempAddress, setTempAddress] = useState('');

          useEffect(() => {
            const saved = localStorage.getItem('entryQRCode');
            if(saved) setQrCode(saved);
            
            const savedCar = localStorage.getItem('carRentalInfo');
            if(savedCar) {
                const parsed = JSON.parse(savedCar);
                setCarRental(parsed);
                setTempAddress(parsed.address);
            }
          }, []);

          const handleQRUpload = (e) => {
            const file = e.target.files?.[0];
            if(file) processImage(file, (b64) => {
                setQrCode(b64);
                localStorage.setItem('entryQRCode', b64);
            });
          };

          const handleCarImgUpload = (e) => {
            const file = e.target.files?.[0];
            if(file) processImage(file, (b64) => {
                const newData = { ...carRental, img: b64 };
                setCarRental(newData);
                localStorage.setItem('carRentalInfo', JSON.stringify(newData));
            });
          };

          const saveCarAddress = () => {
            const newData = { ...carRental, address: tempAddress };
            setCarRental(newData);
            localStorage.setItem('carRentalInfo', JSON.stringify(newData));
            setIsEditingCar(false);
          };

          return (
            <div className="pt-24 pb-24 px-4 space-y-6 animate-fade-in">
              {/* QR Code */}
              <div className="bg-white rounded-2xl p-5 border-l-4 border-muji-accent shadow-sm">
                <h3 className="font-bold text-2xl text-muji-primary mb-4 flex items-center gap-3">
                  <i className="fa-solid fa-qrcode"></i> 入境 QR Code
                </h3>
                {qrCode ? (
                    <div className="text-center mb-4 relative">
                        <img src={qrCode} className="max-w-full h-auto rounded-lg border-2 border-gray-200 mx-auto shadow-sm cursor-pointer" onClick={()=>setFullImg(qrCode)} />
                        <button onClick={()=>{setQrCode(null); localStorage.removeItem('entryQRCode');}} className="mt-4 text-red-500 border border-red-500 px-4 py-2 rounded-lg text-sm flex items-center justify-center gap-2 mx-auto"><i className="fa-solid fa-trash"></i> 刪除重傳</button>
                    </div>
                ) : (
                    <div className="text-center py-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                        <i className="fa-regular fa-image text-gray-300 text-5xl mb-3"></i>
                        <label className="inline-flex items-center gap-2 bg-muji-primary text-white px-6 py-3 rounded-xl font-bold cursor-pointer shadow-md">
                            <i className="fa-solid fa-upload"></i> 上傳 QR Code
                            <input type="file" accept="image/*" className="hidden" onChange={handleQRUpload} />
                        </label>
                    </div>
                )}
              </div>

              {/* Car Rental Management */}
              <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 border-t-4 border-t-orange-400">
                <div className="flex justify-between items-center mb-5">
                    <h3 className="font-bold text-xl text-muji-primary flex items-center gap-2">
                        <i className="fa-solid fa-car"></i> 租車資訊
                    </h3>
                    <button onClick={() => setIsEditingCar(!isEditingCar)} className="p-2 text-muji-primary hover:bg-gray-50 rounded-full transition-all">
                        <i className={`fa-solid ${isEditingCar ? 'fa-xmark' : 'fa-pen-to-square'}`}></i>
                    </button>
                </div>

                <div className="space-y-5">
                    {carRental.img ? (
                        <div className="relative group">
                            <img src={carRental.img} className="w-full h-48 object-cover rounded-xl border border-gray-100 shadow-sm cursor-pointer" onClick={()=>setFullImg(carRental.img)} />
                            {isEditingCar && (
                                <label className="absolute inset-0 bg-black/40 flex items-center justify-center text-white cursor-pointer rounded-xl">
                                    <i className="fa-solid fa-camera text-2xl"></i>
                                    <input type="file" accept="image/*" className="hidden" onChange={handleCarImgUpload} />
                                </label>
                            )}
                        </div>
                    ) : (
                        <label className="w-full h-32 bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-400 cursor-pointer active:bg-gray-100 transition-colors">
                            <i className="fa-solid fa-car text-3xl mb-2 opacity-20"></i>
                            <span className="text-sm">上傳合約或車輛截圖</span>
                            <input type="file" accept="image/*" className="hidden" onChange={handleCarImgUpload} />
                        </label>
                    )}

                    <div className="pt-2">
                        {isEditingCar ? (
                            <div className="flex gap-2">
                                <input value={tempAddress} onChange={e=>setTempAddress(e.target.value)} placeholder="輸入租車公司地址" className="flex-1 border-2 border-muji-primary/20 rounded-lg px-3 py-2 outline-none focus:border-muji-primary" />
                                <button onClick={saveCarAddress} className="bg-muji-primary text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-md"><i className="fa-solid fa-check"></i></button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {carRental.address ? (
                                    <>
                                        <p className="text-gray-700 font-medium leading-relaxed">{carRental.address}</p>
                                        <a href={getMapLink(carRental.address)} target="_blank" className="inline-flex items-center gap-2 bg-muji-accent/10 text-muji-accent px-4 py-2 rounded-lg font-bold text-sm border border-muji-accent/20 active:scale-95 transition-transform"><i className="fa-solid fa-location-dot"></i> 在地圖開啟</a>
                                    </>
                                ) : (
                                    <p className="text-gray-400 text-sm italic text-center py-2">尚未設定地點</p>
                                )}
                            </div>
                        )}
                    </div>
                    {isEditingCar && carRental.address && (
                        <button onClick={()=>{if(confirm('清除全部資訊?')){setCarRental({img:null, address:''}); setTempAddress(''); localStorage.removeItem('carRentalInfo'); setIsEditingCar(false);}}} className="w-full py-2 text-red-500 text-[10px] flex items-center justify-center gap-1 border border-red-100 rounded-lg"><i className="fa-solid fa-trash"></i> 清空資料</button>
                    )}
                </div>
              </div>

              {/* Hotel */}
              <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h3 className="font-bold text-xl text-muji-primary mb-5 flex items-center gap-2"><i className="fa-solid fa-bed"></i> 住宿資訊</h3>
                <div className="space-y-6">
                    {HOTEL_LIST.map((hotel, idx) => (
                        <div key={idx} className="border-b border-gray-100 last:border-0 pb-4 last:pb-0">
                            <div className="flex justify-between items-start">
                                <h4 className="font-bold text-lg text-gray-800 mb-1">{hotel.name}</h4>
                                <span className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-md whitespace-nowrap">{hotel.note}</span>
                            </div>
                            <a href={getMapLink(hotel.address)} target="_blank" className="text-gray-500 text-sm flex items-start gap-1 hover:text-muji-primary mt-1"><i className="fa-solid fa-location-dot mt-1"></i> {hotel.address}</a>
                        </div>
                    ))}
                </div>
              </div>

              {/* Weather */}
              <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                 <h3 className="font-bold text-xl text-muji-primary mb-4 flex items-center justify-between">天氣預報 <span className="text-xs text-gray-400 font-normal"><i className="fa-solid fa-up-right-from-square"></i> tenki.jp</span></h3>
                 <a href="https://tenki.jp" target="_blank" className="border-2 border-muji-primary text-muji-primary rounded-xl py-4 font-bold text-center flex items-center justify-center gap-3 hover:bg-muji-primary hover:text-white transition-colors w-full text-lg shadow-sm"><i className="fa-solid fa-cloud-sun"></i> 前往日本天氣預報</a>
              </div>

              {/* Emergency */}
              <div className="bg-red-50/30 rounded-2xl p-6 border-l-4 border-red-400 shadow-sm">
                 <h3 className="font-bold text-xl text-red-800 mb-4 flex items-center gap-2"><i className="fa-solid fa-triangle-exclamation"></i> 緊急聯絡</h3>
                 <div className="space-y-4 text-base">
                    <div className="flex justify-between items-center border-b border-red-100 pb-2"><span className="text-gray-700">警察局 (Police)</span><a href="tel:110" className="font-bold font-mono text-2xl text-red-600">110</a></div>
                    <div className="flex justify-between items-center border-b border-red-100 pb-2"><span className="text-gray-700">救護車 (Fire/Amb)</span><a href="tel:119" className="font-bold font-mono text-2xl text-red-600">119</a></div>
                    <div className="mt-4 text-sm text-gray-600 space-y-2"><p><strong>台北駐日經濟文化代表處:</strong><br/><a href="tel:0332807111" className="text-blue-600 text-lg">03-3280-7111</a></p><p><strong>緊急聯絡電話:</strong><br/><a href="tel:08010097179" className="text-blue-600 text-lg">080-1009-7179</a></p></div>
                 </div>
              </div>

              {fullImg && <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 animate-fade-in" onClick={()=>setFullImg(null)}><img src={fullImg} className="max-w-full max-h-full rounded-lg shadow-2xl"/></div>}
            </div>
          );
        };

        // MAIN APP
        const App = () => {
            const [tab, setTab] = useState('plan');
            const [date, setDate] = useState('');
            const [coverImg, setCoverImg] = useState(null);

            useEffect(() => {
                setDate(new Date().toLocaleDateString());
                const saved = localStorage.getItem('planCoverImg');
                if(saved) setCoverImg(saved);
            }, []);

            useEffect(() => {
                const favicon = document.getElementById('favicon');
                const appleIcon = document.getElementById('apple-touch-icon');
                if (coverImg) {
                    if(favicon) favicon.href = coverImg;
                    if(appleIcon) appleIcon.href = coverImg;
                } else {
                    const defaultIcon = "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>❄️</text></svg>";
                    if(favicon) favicon.href = defaultIcon;
                    if(appleIcon) appleIcon.href = defaultIcon;
                }
            }, [coverImg]);

            const handleCoverUpdate = (img) => {
                setCoverImg(img);
                if(img) localStorage.setItem('planCoverImg', img);
                else localStorage.removeItem('planCoverImg');
            };

            const renderContent = () => {
                if(tab === 'plan') return <PlanView coverImg={coverImg} onUpdateCover={handleCoverUpdate} />;
                if(tab === 'food') return <FoodView />;
                if(tab === 'wallet') return <WalletView />;
                if(tab === 'lists') return <ListsView />;
                if(tab === 'info') return <InfoView />;
            };

            const NavBtn = ({t, i, l}) => (
                <button onClick={()=>{setTab(t); window.scrollTo(0,0)}} className={`flex flex-col items-center justify-center w-full py-2 transition-colors duration-300 ${tab===t ? 'text-muji-primary' : 'text-gray-400'}`}>
                    <i className={`fa-solid ${i} text-2xl mb-1`}></i>
                    <span className={`text-xs ${tab===t ? 'font-bold' : 'font-medium'}`}>{l}</span>
                </button>
            );

            return (
                <div className="min-h-screen font-sans text-muji-text bg-[#F9F8F6]">
                    <header className="fixed top-0 w-full bg-[#F9F8F6]/95 backdrop-blur-sm z-50 border-b border-muji-border px-4 h-[70px] flex justify-between items-center shadow-sm">
                        <h1 className="text-2xl font-bold tracking-widest text-muji-primary flex items-center gap-2">
                            {coverImg ? <img src={coverImg} className="w-8 h-8 rounded-md object-cover border border-white shadow-sm"/> : <span><i className="fa-solid fa-person-skiing"></i></span>}
                            滑雪不跌倒
                        </h1>
                        <div className="text-sm text-gray-500 font-medium">{date}</div>
                    </header>
                    <main>{renderContent()}</main>
                    <nav className="fixed bottom-0 w-full bg-white border-t border-gray-200 z-50 pb-[env(safe-area-inset-bottom)] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <div className="flex justify-between items-center px-1 h-[65px]">
                            <NavBtn t="plan" i="fa-calendar-days" l="行程" />
                            <NavBtn t="food" i="fa-utensils" l="美食" />
                            <NavBtn t="wallet" i="fa-wallet" l="記帳" />
                            <NavBtn t="lists" i="fa-list-check" l="清單" />
                            <NavBtn t="info" i="fa-circle-info" l="資訊" />
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
