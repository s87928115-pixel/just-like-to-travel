<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Japan Trip 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#fcfaf2', // Á±≥Ëâ≤ËÉåÊôØ
                            card: '#ffffff',
                            text: '#4a4a4a',
                            accent: '#2c5d63', // Ê≤âÁ©©ËóçÁ∂†
                            secondary: '#8c8c8c',
                            border: '#e6e6e6',
                            highlight: '#d4493e' // Âç∞Á´†Á¥Ö (ÈáçË¶ÅÊèêÈÜí)
                        }
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles for App-like feel */
        body {
            background-color: #fcfaf2;
            color: #4a4a4a;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }
        
        .page-container {
            padding-bottom: 90px; /* Space for bottom nav */
            padding-top: 10px;
            min-height: 100vh;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .page-container.active {
            display: block;
            opacity: 1;
        }

        /* Hide Scrollbar */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        /* Card Styles */
        .muji-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            border: 1px solid #f0f0f0;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .muji-btn {
            background-color: #2c5d63;
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            transition: opacity 0.2s;
        }
        .muji-btn:active { opacity: 0.8; }

        .timeline-line {
            position: absolute;
            left: 24px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e5e5e5;
            z-index: 0;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            background-color: #2c5d63;
            border-radius: 50%;
            border: 2px solid white;
            z-index: 10;
            position: relative;
        }

        /* Custom Input styling */
        .muji-input {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            width: 100%;
            background: #fafafa;
            outline: none;
        }
        .muji-input:focus { border-color: #2c5d63; background: white; }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #2c5d63;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans antialiased text-muji-text">

    <div id="app" class="max-w-md mx-auto relative bg-muji-bg min-h-screen shadow-2xl">

        <header class="fixed top-0 w-full max-w-md bg-white/90 backdrop-blur-md z-50 border-b border-muji-border px-4 py-3 flex justify-between items-center shadow-sm">
            <h1 class="text-xl font-bold tracking-widest text-muji-accent">JAPAN 2026</h1>
            <div class="text-xs text-right">
                <div id="currentDate"></div>
                <div class="text-muji-secondary" id="weatherWidget">Êù±‰∫¨ ‚õÖ 8¬∞C</div>
            </div>
        </header>
        
        <div class="h-16"></div> <div id="page-plan" class="page-container active px-4">
            <div class="mb-4">
                <h2 class="text-2xl font-bold mb-1 text-muji-text">Itinerary</h2>
                <p class="text-xs text-muji-secondary">2/24 - 3/6 (11 Days)</p>
            </div>
            
            <div id="itinerary-list" class="space-y-6 relative pb-10">
                </div>
        </div>

        <div id="page-food" class="page-container px-4">
            <h2 class="text-2xl font-bold mb-4 text-muji-text">Food Guide</h2>
            <div id="food-list" class="space-y-4">
                </div>
            
            <button onclick="alert('Èï∑ÊåâÊ®ôÈ°åÂèØÁ∑®ËºØÂÖßÂÆπÔºå‰ΩøÁî® LocalStorage ÂÑ≤Â≠ò')" class="fixed bottom-24 right-6 bg-muji-accent text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-xl z-40">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div id="page-wallet" class="page-container px-4">
            <h2 class="text-2xl font-bold mb-4 text-muji-text">Wallet</h2>

            <div class="muji-card p-4 mb-4 bg-white sticky top-16 z-30 shadow-md">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold text-muji-secondary">ÂåØÁéáÊèõÁÆó (1 JPY = <span id="displayRate">0.22</span> TWD)</span>
                    <i class="fa-solid fa-gear text-gray-300 cursor-pointer" onclick="toggleRateEdit()"></i>
                </div>
                <div id="rateEditor" class="hidden mb-2">
                    <input type="number" id="customRate" step="0.001" class="muji-input h-8 text-sm" placeholder="Ë®≠ÂÆöÂåØÁéá ex: 0.215" onchange="updateRate()">
                </div>

                <div class="flex items-center space-x-2">
                    <div class="relative w-full">
                        <span class="absolute left-3 top-2.5 text-gray-400">¬•</span>
                        <input type="text" id="calcInput" class="muji-input pl-8 text-lg font-mono font-bold" placeholder="Ëº∏ÂÖ•ÁÆóÂºè ex: 500+200*2">
                    </div>
                    <div class="text-2xl font-bold text-muji-accent">=</div>
                    <div class="text-right min-w-[80px]">
                        <div class="text-xs text-gray-400">NT$</div>
                        <div class="text-xl font-bold" id="twdResult">0</div>
                    </div>
                </div>
            </div>

            <div class="muji-card p-4 mb-6">
                <h3 class="text-sm font-bold mb-3 text-muji-accent">Êñ∞Â¢ûË®òÂ∏≥</h3>
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <input type="text" id="expenseItem" class="muji-input col-span-2" placeholder="ÂìÅÈ†ÖÂêçÁ®±">
                    <input type="number" id="expensePrice" class="muji-input" placeholder="¬•ÈáëÈ°ç">
                </div>
                <div class="flex justify-between items-center">
                    <label class="flex items-center space-x-2 cursor-pointer bg-gray-100 px-3 py-2 rounded-lg text-sm">
                        <i class="fa-solid fa-camera text-muji-secondary"></i>
                        <span class="text-xs text-gray-600">ÁÖßÁâá</span>
                        <input type="file" id="expenseImg" accept="image/*" class="hidden" onchange="handleImagePreview(this)">
                    </label>
                    <div id="imgPreviewArea" class="hidden w-8 h-8 rounded bg-cover bg-center border border-gray-300"></div>
                    
                    <button onclick="addExpense()" class="muji-btn text-sm px-6">
                        <i class="fa-solid fa-check mr-1"></i> ÂÑ≤Â≠ò
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-end mb-2">
                <h3 class="text-lg font-bold">Ê∂àË≤ªÁ¥ÄÈåÑ</h3>
                <div class="text-xs text-right">
                    Á∏ΩË®à: <span class="font-bold text-muji-accent">¬•<span id="totalJpy">0</span></span>
                    <br>
                    (Á¥Ñ NT$<span id="totalTwd">0</span>)
                </div>
            </div>
            <div id="expenseList" class="space-y-3 pb-10">
                </div>
        </div>

        <div id="page-lists" class="page-container px-4">
            <div class="flex space-x-2 mb-4 overflow-x-auto pb-2" id="listTabs">
                <button onclick="switchListTab('packing')" class="list-tab-btn active px-4 py-2 rounded-full text-sm font-bold border border-muji-accent bg-muji-accent text-white">ÂøÖÂÇôÊ∏ÖÂñÆ</button>
                <button onclick="switchListTab('memo')" class="list-tab-btn px-4 py-2 rounded-full text-sm font-bold border border-muji-border bg-white text-gray-500">ÂÇôÂøòÈåÑ</button>
                <button onclick="switchListTab('shop')" class="list-tab-btn px-4 py-2 rounded-full text-sm font-bold border border-muji-border bg-white text-gray-500">Ë≥ºË≤∑Ê∏ÖÂñÆ</button>
            </div>

            <div id="list-packing" class="list-content">
                </div>

            <div id="list-memo" class="list-content hidden">
                <textarea id="memoInput" class="muji-input h-32 mb-2" placeholder="Ëº∏ÂÖ•ÂÇôÂøò‰∫ãÈ†Ö... (Ëº∏ÂÖ•Á∂≤ÂùÄÊúÉËá™ÂãïËÆäÈÄ£Áµê)"></textarea>
                <button onclick="saveMemo()" class="muji-btn w-full mb-4">Êñ∞Â¢ûÂÇôÂøò</button>
                <div id="memoContainer" class="space-y-3"></div>
            </div>

            <div id="list-shop" class="list-content hidden">
                <div class="flex space-x-2 mb-2">
                    <input type="text" id="shopInput" class="muji-input" placeholder="ÊÉ≥Ë≤∑‰ªÄÈ∫º...">
                    <button onclick="addShopItem()" class="muji-btn whitespace-nowrap">Êñ∞Â¢û</button>
                </div>
                 <div id="shopContainer" class="space-y-3"></div>
            </div>
        </div>

        <div id="page-info" class="page-container px-4">
            <h2 class="text-2xl font-bold mb-4 text-muji-text">Info & Docs</h2>
            
            <div class="space-y-4">
                <div class="muji-card p-4">
                    <h3 class="font-bold mb-2 flex items-center"><i class="fa-solid fa-qrcode mr-2 text-muji-accent"></i> ÂÖ•Â¢É QR Code</h3>
                    <div class="grid grid-cols-2 gap-4" id="qrContainer">
                        </div>
                    <label class="mt-3 block text-center border-2 border-dashed border-gray-300 rounded-lg p-2 cursor-pointer hover:bg-gray-50">
                        <span class="text-xs text-gray-500">+ ‰∏äÂÇ≥Êà™Âúñ</span>
                        <input type="file" accept="image/*" class="hidden" onchange="addQRCode(this)">
                    </label>
                </div>

                <div class="muji-card p-4 border-l-4 border-red-500">
                    <h3 class="font-bold text-red-600 mb-2">Á∑äÊÄ•ËÅØÁµ°</h3>
                    <ul class="text-sm space-y-2">
                        <li>üëÆ Ë≠¶ÂØü: 110</li>
                        <li>üöë ÊïëË≠∑/ÁÅ´Ë≠¶: 119</li>
                        <li>üáπüáº ÈßêÊó•‰ª£Ë°®Ëôï (Êù±‰∫¨): +81-3-3280-7811</li>
                        <li class="text-xs text-gray-500 mt-2">Á∑äÊÄ•ËÅØÁµ°Âç°Â∑≤Â≠òÊñº LocalStorage</li>
                    </ul>
                </div>

                <div class="muji-card">
                    <button class="w-full text-left p-4 font-bold flex justify-between items-center" onclick="toggleAccordion('hotelInfo')">
                        <span>üè® ‰ΩèÂÆøË≥áË®ä</span>
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </button>
                    <div id="hotelInfo" class="hidden px-4 pb-4 text-sm space-y-4 border-t border-gray-100 pt-2">
                        </div>
                </div>

                 <div class="muji-card">
                    <button class="w-full text-left p-4 font-bold flex justify-between items-center" onclick="toggleAccordion('carInfo')">
                        <span>üöó ÁßüËªäË≥áË®ä</span>
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </button>
                    <div id="carInfo" class="hidden px-4 pb-4 text-sm space-y-4 border-t border-gray-100 pt-2">
                        <div>
                            <p class="font-bold">DAY 1 Ëºï‰∫ïÊæ§ÁßüÈõ™ÂÖ∑</p>
                            <p class="text-xs text-gray-500">4-8 KARUIZAWAHIGASHI, KARUIZAWA</p>
                            <button onclick="openMap('4-8 KARUIZAWAHIGASHI, KARUIZAWA, KITASAKU DISTRICT, NAGANO')" class="mt-1 text-xs text-blue-500 underline">ÈñãÂïüÂú∞Âúñ</button>
                        </div>
                        </div>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 flex justify-around items-center py-2 z-50 pb-safe">
            <button onclick="navTo('plan')" class="nav-btn active flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-regular fa-calendar-days text-xl mb-1"></i>
                <span class="text-[10px]">Ë°åÁ®ã</span>
            </button>
            <button onclick="navTo('food')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-utensils text-xl mb-1"></i>
                <span class="text-[10px]">È£üË®ò</span>
            </button>
            <button onclick="navTo('wallet')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-wallet text-xl mb-1"></i>
                <span class="text-[10px]">Ë®òÂ∏≥</span>
            </button>
            <button onclick="navTo('lists')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-list-check text-xl mb-1"></i>
                <span class="text-[10px]">Ê∏ÖÂñÆ</span>
            </button>
            <button onclick="navTo('info')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-circle-info text-xl mb-1"></i>
                <span class="text-[10px]">Ë≥áË®ä</span>
            </button>
        </nav>

    </div>

    <script>
        // --- DATA OBJECTS (FROM USER INPUT) ---
        const hotels = [
            { name: "Ëºï‰∫ïÊæ§ÁéãÂ≠êÈ£ØÂ∫óË•øÈ§®", date: "2/24-2/27", address: "389-0193 Èï∑ÈáéÁ∏£Âåó‰Ωê‰πÖÈÉ°Ëºï‰∫ïÊæ§Áî∫Ëºï‰∫ïÊæ§1016-85", tel: "+81-(0)267-42-1113" },
            { name: "LANDABOUT TOKYO", date: "2/27-2/28", address: "Êù±‰∫¨ÈÉΩ, Êù±‰∫¨, Taito-ku Negishi 3-4-5", tel: "+81-3-6802-4437" },
            { name: "Route Inn Êñ∞ËéäÁ´ôÂâç", date: "2/28-3/1", address: "Â±±ÂΩ¢ÁúåÊñ∞Â∫ÑÂ∏ÇÈáëÊ≤¢Ê≤ñ1109-6", tel: "050-1809-5168" },
            { name: "The OneFive Sendai", date: "3/1-3/4", address: "4 Chome-6-28 Tsutsujigaoka, Miyagino Ward, Sendai, Miyagi 983-0852", tel: "" },
            { name: "Route Inn Yamagataminami", date: "3/4", address: "1 Chome-1-11 Iidanishi, Yamagata, 990-2331", tel: "" },
            { name: "The OneFive Sendai", date: "3/5", address: "4 Chome-6-28 Tsutsujigaoka, Miyagino Ward, Sendai, Miyagi 983-0852", tel: "" },
        ];

        const packingList = {
            "ÂÄã‰∫∫Áâ©ÂìÅ": ["Ë≠∑ÁÖß", "‰ø°Áî®Âç°", "Ë∫´ÂàÜË≠â", "ÁèæÈáë", "Ë∫´ÂàÜË≠âÂΩ±Êú¨", "Ë≠∑ÁÖßÂΩ±Êú¨", "ÈßïÁÖß", "ÂúãÈöõÈßïÁÖß", "ÈßïÁÖßË≠ØÊú¨"],
            "ÈõúÁâ©": ["Ë°£Áâ©", "Â∏ΩÂ≠ê", "Â§™ÈôΩÁúºÈè°", "Èö±Áúº", "Ê¢≥Â≠ê", "‰øùÈ§äÂìÅ(‰π≥Ê∂≤/Ë≠∑ÊâãÈúú)", "Ëó•ÂìÅ(ÊÑüÂÜí/ÊöàËªä/ÈÅéÊïè)"],
            "ÈõªÂ≠êÁî¢ÂìÅ": ["ÂÖÖÈõªÂô®", "ÂÖÖÈõªÁ∑ö", "Ë°åÂãïÈõªÊ∫ê", "Ëê¨ÂúãÊèíÂ∫ß", "GoPro/Áõ∏Ê©ü", "ÈõªÊ±†/Ë®òÊÜ∂Âç°", "Á∂≤Âç°/SIMÈáù"],
            "ÊªëÈõ™Ê∫ñÂÇô": ["Èõ™Èè°", "ÊéíÊ±óË°£", "‰øùÊöñÈï∑Ë¢ñ", "ÊâãÂ•ó", "Èï∑Ë•™", "Èò≤ÊªëÈûã", "Â±ÅÂ¢ä", "ÊöñÊöñÂåÖ", "Ë≠∑ËÜù", "Ë≠∑Êâã", "ÂÜ∞Áà™"]
        };

        const itinerary = [
            { 
                day: 1, date: "2/24 (‰∫å)", title: "ÊäµÈÅî & ÁßªÂãïËºï‰∫ïÊæ§", icon: "fa-plane",
                events: [
                    { time: "06:40", title: "ÈÖ∑Ëà™ TR898 Âá∫Áôº", note: "Á¨¨‰∏ÄËà™Âªà", type: "flight" },
                    { time: "10:45", title: "ÊäµÈÅîÊàêÁî∞Ê©üÂ†¥", note: "", type: "flight" },
                    { time: "11:13~", title: "Êê≠ËªäÂâçÂæÄ‰∏äÈáé", note: "ËªäÁ®ã50ÂàÜ (Áè≠Ê¨°: 11:13, 11:39, 11:59...)", type: "train" },
                    { time: "12:00", title: "‰∏äÈáéÂçàÈ§ê", note: "ËüπÈ£üÊîæÈ°å / ÁÇ∏Ë±¨Êéí / Â£ΩÂè∏ (Ë©≥Ë¶ãÈ£üË®ò)", type: "food" },
                    { time: "15:10", title: "Êñ∞ÂππÁ∑ö -> Ëºï‰∫ïÊæ§", note: "‰∏äÈáéÂá∫Áôº", type: "train", highlight: true },
                    { time: "16:30", title: "ÁßüÈõ™ÂÖ∑", note: "4-8 Karuizawahigashi", address: "4-8 KARUIZAWAHIGASHI, KARUIZAWA, KITASAKU DISTRICT, NAGANO 389-0104", type: "activity" },
                    { time: "18:00", title: "ÊôöÈ§ê", note: "Ê∂ÆÊ∂ÆÈçã / ÁáíËÇâ / ÊùëÊ∞ëÈ£üÂ†Ç", type: "food" }
                ]
            },
            {
                day: 2, date: "2/25 (‰∏â)", title: "ÊªëÈõ™Êó•", icon: "fa-person-skiing",
                events: [
                    { time: "All Day", title: "ÊªëÈõ™", note: "Ëºï‰∫ïÊæ§ÊªëÈõ™Â†¥", type: "activity" }
                ]
            },
            {
                day: 3, date: "2/26 (Âõõ)", title: "ÊªëÈõ™ & ÁßüËªä", icon: "fa-person-skiing",
                events: [
                    { time: "09:00", title: "ÊªëÈõ™", note: "Ëá≥ 16:00", type: "activity" },
                    { time: "17:00", title: "ÁßüËªä", note: "", type: "car", highlight: true }
                ]
            },
            {
                day: 4, date: "2/27 (‰∫î)", title: "Ëºï‰∫ïÊæ§ËßÄÂÖâ & ÂõûÊù±‰∫¨", icon: "fa-camera",
                events: [
                    { time: "09:30", title: "Ê¶ÜÊ®πË°óÂ∞èÈéÆ", type: "sight" },
                    { time: "11:00", title: "Èõ≤Â†¥Ê±†", type: "sight" },
                    { time: "11:30", title: "ËàäËºï‰∫ïÊæ§ÈäÄÂ∫ßÈÄö", type: "sight" },
                    { time: "13:57", title: "Êñ∞ÂππÁ∑öÂõû‰∏äÈáé", note: "Áè≠Ê¨°: 13:57, 15:00, 15:35, 15:56", type: "train", highlight: true },
                    { time: "18:00", title: "‰∏äÈáéÊôöÈ§ê", note: "Ëø¥ËΩâÂ£ΩÂè∏ / Ë±¨Êéí / ÈäÖÈëºÁáí", type: "food" }
                ]
            },
            {
                day: 5, date: "2/28 (ÂÖ≠)", title: "Êù±‰∫¨ÈÄõË°ó -> Â±±ÂΩ¢Êñ∞Â∫Ñ", icon: "fa-train",
                events: [
                    { time: "09:30", title: "Â¶ôÁæ©Á•ûÁ§æ", address: "3 Chome-16-16 Komagome, Toshima City, Tokyo", type: "sight" },
                    { time: "10:30", title: "Ê±†Ë¢ãÂ§™ÈôΩÂüé", type: "shop" },
                    { time: "13:30", title: "ÊäµÈÅî‰∏äÈáéËªäÁ´ô", type: "train" },
                    { time: "14:00", title: "Êñ∞ÂππÁ∑ö -> Êñ∞Â∫Ñ", note: "ÁßªÂãïÊó•", type: "train", highlight: true }
                ]
            },
            {
                day: 6, date: "3/1 (Êó•)", title: "ÊúÄ‰∏äÂ∑ùÈÅäËàπ -> ‰ªôÂè∞", icon: "fa-ship",
                events: [
                    { time: "07:50", title: "Âá∫ÈñÄ", type: "info" },
                    { time: "08:10", title: "JRÈô∏ÁæΩË•øÁ∑ö -> Âè§Âè£", note: "08:50ÊäµÈÅî", type: "train" },
                    { time: "09:00", title: "ÊúÄ‰∏äÂ∑ùÈÅäËàπ", type: "activity", highlight: true },
                    { time: "12:05", title: "ÂõûÊñ∞Â∫Ñ", note: "ÂæûÈ´òÂ±ãÊàñÂè§Âè£Âá∫Áôº", type: "train" },
                    { time: "14:19", title: "PLAN B: ÁßªÂãïËá≥‰ªôÂè∞", note: "JRÂ•ßÁæΩÊú¨Á∑ö -> Â±±ÂΩ¢ -> Â∑¥Â£´ -> ‰ªôÂè∞", type: "train" },
                    { time: "19:40", title: "Check in & ÊôöÈ§ê", type: "hotel" }
                ]
            },
            {
                day: 7, date: "3/2 (‰∏Ä)", title: "Â±±ÂØ∫ or Êé°ËçâËéì", icon: "fa-mountain",
                events: [
                    { time: "08:00", title: "PLAN A: Â±±ÂØ∫", note: "8:18 Âá∫Áôº, ÂçàÈ§ê: ÁÑ∞ËóèËïéÈ∫•È∫µ", type: "sight" },
                    { time: "08:30", title: "PLAN B: ‰ªôÂè∞ÊúùÂ∏Ç", type: "sight" },
                    { time: "09:30", title: "PLAN B: ÁßüËªä & Êé°ËçâËéì", note: "‰∏ÄËã∫‰∏ÄÁ¨ë ÊùæÊ£ÆËæ≤Â†¥", address: "Shiromae-157-1 Matsumori, Izumi Ward, Sendai", type: "activity" },
                    { time: "13:00", title: "Costco ÂØåË∞∑ÂÄâÂ∫´Â∫ó", type: "shop" }
                ]
            },
            {
                day: 8, date: "3/3 (‰∫å)", title: "‰ªôÂè∞Â∏ÇÂçÄËßÄÂÖâ", icon: "fa-torii-gate",
                events: [
                    { time: "09:30", title: "ÁëûÈ≥≥ÊÆø", type: "sight" },
                    { time: "11:00", title: "Â§ßÂ¥éÂÖ´Âπ°ÂÆÆ", type: "sight" },
                    { time: "15:00", title: "ÁßüËªä", type: "car", highlight: true },
                    { time: "18:30", title: "ÊôöÈ§ê: ËÇâÂçÅÂÖ´", type: "food" }
                ]
            },
            {
                day: 9, date: "3/4 (‰∏â)", title: "ÁãêÁã∏Êùë & ËóèÁéãÊ®πÂÜ∞", icon: "fa-snowflake",
                events: [
                    { time: "09:00", title: "ÈáëÁ•ûÊ∞¥Á•ûÁ§æ", type: "sight" },
                    { time: "10:30", title: "ËóèÁéãÁãêÁã∏Êùë", address: "Êó•Êú¨„Äí989-0733 Miyagi, Shiroishi, Á¶èÂ≤°ÂÖ´ÂÆÆÂ∑ùÂéüÂ≠êÔºëÔºë‚àíÔºì", type: "activity", highlight: true },
                    { time: "12:40", title: "ÈÅ†ÂààÁî∞Ê∫´Ê≥â", type: "sight" },
                    { time: "15:15", title: "ËóèÁéãÊ®πÂÜ∞", address: "229-3 Zaoonsen, Yamagata", type: "sight", highlight: true },
                    { time: "17:30", title: "Check-in Â±±ÂΩ¢", type: "hotel" },
                    { time: "18:00", title: "ÊôöÈ§ê", note: "ÈÖíËèú‰∏Ä / Â±±ÂΩ¢ËÇâÂïèÂ±ã", type: "food" }
                ]
            },
            {
                day: 10, date: "3/5 (Âõõ)", title: "ÈäÄÂ±±Ê∫´Ê≥â & ÊùæÂ≥∂", icon: "fa-spa",
                events: [
                    { time: "09:10", title: "ÈÅì„ÅÆÈßÖ Â§©Á´•Ê∏©Ê≥â", type: "shop" },
                    { time: "10:40", title: "Â§ßÊ≠£Êµ™Êº´È§®", note: "Êê≠11:00Êé•ÈßÅËªä -> ÈäÄÂ±±Ê∫´Ê≥â", type: "bus", highlight: true },
                    { time: "12:30", title: "Êé•ÈßÅËªäÂõûÂ§ßÊ≠£Êµ™Êº´È§®", type: "bus" },
                    { time: "16:00", title: "ÊùæÂ≥∂Êµ∑Â≤∏", type: "sight" },
                    { time: "18:00", title: "‰∏â‰∫ï OUTLET ‰ªôÂè∞Ê∏Ø", type: "shop" }
                ]
            },
            {
                day: 11, date: "3/6 (‰∫î)", title: "ÂõûÁ®ã", icon: "fa-plane-departure",
                events: [
                    { time: "11:30", title: "‰ªôÂè∞ -> AEON MALL", type: "shop" },
                    { time: "14:47", title: "ÂâçÂæÄ‰ªôÂè∞Ê©üÂ†¥", type: "train" },
                    { time: "17:25", title: "ÊòüÂÆá JX863 Ëµ∑È£õ", note: "20:35 ÊäµÈÅîÂè∞ÁÅ£", type: "flight", highlight: true }
                ]
            }
        ];

        const foodData = [
            { day: "D1 ‰∏äÈáé/Ëºï‰∫ïÊæ§", spots: [
                { name: "ËüπÈ£üÊîæÈ°å „Åî„Å£„Å§„Åä", type: "ÂçàÈ§ê", address: "Êù±‰∫¨ÈÉΩÊñá‰∫¨ÂçÄÊπØÂ≥∂„É©„Ç§„ÉØ„Éì„É´ 4F", note: "ËûÉËüπÂêÉÂà∞È£Ω" },
                { name: "Êù±‰∫¨ÁÇ∏Ë±¨Êéí „Åå„Å∂„ÅÜ", type: "ÂçàÈ§ê", address: "Êù±‰∫¨ÈÉΩÂè∞Êù±ÂçÄ‰∏äÈáé4-6-4 OGS‚Ö° B1F", note: "" },
                { name: "„Åó„ÇÉ„Å∂„Åó„ÇÉ„Å∂ÊÑõÂÆï", type: "ÊôöÈ§ê", address: "389-0104Èï∑ÈáéÁúåÂåó‰Ωê‰πÖÈÉ°ËªΩ‰∫ïÊ≤¢Áî∫Êù±167", note: "Ëºï‰∫ïÊæ§Ê∂ÆÊ∂ÆÈçã", tel: "0267-41-6111" },
                { name: "ÊùëÊ∞ëÈ£üÂ†Ç", type: "ÊôöÈ§ê", address: "389-0104Èï∑ÈáéÁúåÂåó‰Ωê‰πÖÈÉ°ËªΩ‰∫ïÊ≤¢Áî∫Èï∑ÂÄâ2148", note: "ÊòüÈáéÂçÄ", tel: "0267-44-3571" }
            ]},
            { day: "D4 Êù±‰∫¨‰∏äÈáé", spots: [
                { name: "‰∏âÊµ¶‰∏âÂ¥éÊ∏ØËø¥ËΩâÂ£ΩÂè∏", type: "ÊôöÈ§ê", address: "Êù±‰∫¨ÈÉΩÂè∞Êù±ÂçÄ‰∏äÈáé6-12-14", note: "È£üÊùêÂ†ÜÂæóÂÉèÂ±±‰∏ÄÊ®£" },
                { name: "„ÅΩ„ÇìÂ§öÊú¨ÂÆ∂ Ë±¨Êéí", type: "ÊôöÈ§ê", address: "Êù±‰∫¨ÈÉΩÂè∞Êù±Âå∫‰∏äÈáé3-23-3", note: "" },
                { name: "‰∏äÈáéÂÖîÂ±ã ÈäÖÈëºÁáí", type: "ÁîúÈªû", address: "Êù±‰∫¨ÈÉΩÂè∞Êù±Âå∫‰∏äÈáéÔºë‰∏ÅÁõÆÔºëÔºê‚àí10", note: "" }
            ]},
            { day: "D7 Â±±ÂØ∫/‰ªôÂè∞", spots: [
                { name: "ÁÑ∞Ëóè (Â±±ÂØ∫Â∫ó)", type: "ÂçàÈ§ê", address: "Â±±ÂØ∫", note: "Â±±ÂΩ¢ËïéÈ∫•È∫µ" }
            ]},
            { day: "D8 ‰ªôÂè∞", spots: [
                { name: "ËÇâÂçÅÂÖ´", type: "ÊôöÈ§ê", address: "‰ªôÂè∞", note: "ÁáíËÇâ" }
            ]},
             { day: "D9 Â±±ÂΩ¢", spots: [
                { name: "ÈÖíËèú‰∏Ä", type: "ÊôöÈ§ê", address: "1 Chome-7-7 Kasumicho, Yamagata", tel:"+815054841844", note: "" },
                { name: "Â±±ÂΩ¢ËÇâÂïèÂ±ã„Çª„É≥„Çø„Éº", type: "ÊôöÈ§ê", address: "Yamagata, Saiwaicho, 1‚àí4 ÈßÖÂçó„Éì„É´ 1F", tel:"+817011455641", note: "" }
            ]}
        ];

        // --- INIT & NAVIGATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initPlan();
            initFood();
            initWallet();
            initLists();
            initInfo();
            updateDate();
        });

        function navTo(pageId) {
            // UI Update
            document.querySelectorAll('.page-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('text-muji-accent');
                el.classList.add('text-muji-secondary');
            });
            event.currentTarget.classList.remove('text-muji-secondary');
            event.currentTarget.classList.add('text-muji-accent');
            
            window.scrollTo(0,0);
        }

        function updateDate() {
            const d = new Date();
            const str = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
            document.getElementById('currentDate').innerText = str;
        }

        function openMap(address) {
            if(!address) return;
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
            window.open(url, '_blank');
        }

        // --- PLAN MODULE ---
        function initPlan() {
            const container = document.getElementById('itinerary-list');
            let html = '';

            itinerary.forEach((day, index) => {
                let eventsHtml = '';
                day.events.forEach(evt => {
                    const highlightClass = evt.highlight ? 'text-muji-highlight font-bold' : '';
                    const borderClass = evt.highlight ? 'border-l-4 border-muji-highlight pl-2' : '';
                    const mapBtn = evt.address ? `<button onclick="openMap('${evt.address}')" class="ml-2 text-muji-accent"><i class="fa-solid fa-location-dot"></i></button>` : '';
                    
                    eventsHtml += `
                        <div class="relative pl-8 pb-6 last:pb-0">
                            <div class="timeline-dot absolute left-[-5px] top-1"></div>
                            <div class="text-sm font-bold text-muji-accent">${evt.time}</div>
                            <div class="bg-white p-3 rounded-lg shadow-sm mt-1 border border-gray-100 ${borderClass}">
                                <div class="font-medium text-base ${highlightClass}">${evt.title} ${mapBtn}</div>
                                ${evt.note ? `<div class="text-xs text-gray-500 mt-1">${evt.note}</div>` : ''}
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div class="relative mb-8">
                        <div class="timeline-line"></div>
                        <div class="flex items-center mb-4 sticky top-16 bg-muji-bg z-20 py-2">
                            <div class="bg-muji-accent text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg shadow-md z-10">
                                ${day.day}
                            </div>
                            <div class="ml-3">
                                <h3 class="font-bold text-lg">${day.date}</h3>
                                <div class="text-xs text-gray-500 flex items-center gap-2">
                                    <i class="fa-solid ${day.icon}"></i> ${day.title}
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            ${eventsHtml}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- FOOD MODULE ---
        function initFood() {
            const container = document.getElementById('food-list');
            let html = '';
            foodData.forEach(section => {
                html += `<h3 class="font-bold text-lg mt-6 mb-3 border-b border-gray-200 pb-1 text-muji-accent">${section.day}</h3>`;
                section.spots.forEach(spot => {
                    html += `
                        <div class="muji-card p-0 flex flex-col">
                            <div class="p-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <span class="text-xs font-bold bg-orange-100 text-orange-600 px-2 py-0.5 rounded">${spot.type}</span>
                                        <h4 class="font-bold text-lg mt-1">${spot.name}</h4>
                                    </div>
                                    <button onclick="openMap('${spot.address}')" class="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center">
                                        <i class="fa-solid fa-location-arrow text-sm"></i>
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mt-2"><i class="fa-solid fa-map-pin mr-1"></i> ${spot.address}</p>
                                ${spot.tel ? `<p class="text-sm text-gray-500"><i class="fa-solid fa-phone mr-1"></i> ${spot.tel}</p>` : ''}
                                ${spot.note ? `<div class="mt-3 text-sm bg-gray-50 p-2 rounded text-gray-600">"${spot.note}"</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            });
            container.innerHTML = html;
        }

        // --- WALLET MODULE ---
        let rate = localStorage.getItem('trip_rate') || 0.22;
        let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];

        function initWallet() {
            document.getElementById('displayRate').innerText = rate;
            document.getElementById('calcInput').addEventListener('input', calculate);
            renderExpenses();
        }

        function toggleRateEdit() {
            document.getElementById('rateEditor').classList.toggle('hidden');
        }

        function updateRate() {
            const val = parseFloat(document.getElementById('customRate').value);
            if(val) {
                rate = val;
                localStorage.setItem('trip_rate', rate);
                document.getElementById('displayRate').innerText = rate;
                calculate();
                renderExpenses(); // Update totals
                toggleRateEdit();
            }
        }

        function calculate() {
            const input = document.getElementById('calcInput').value;
            const resEl = document.getElementById('twdResult');
            try {
                // Safer eval for math only
                if(input.match(/^[0-9+\-*/.() ]+$/)) {
                    const jpy = new Function('return ' + input)();
                    const twd = Math.round(jpy * rate);
                    resEl.innerText = twd.toLocaleString();
                } else if(input === '') {
                    resEl.innerText = '0';
                }
            } catch(e) { /* ignore partial input */ }
        }

        // Image Compression Logic
        let currentExpenseImg = null;
        function handleImagePreview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        // Canvas Compress
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 400; // Limit size
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        currentExpenseImg = canvas.toDataURL('image/jpeg', 0.6); // 60% quality
                        
                        // Show Preview
                        const preview = document.getElementById('imgPreviewArea');
                        preview.style.backgroundImage = `url(${currentExpenseImg})`;
                        preview.classList.remove('hidden');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addExpense() {
            const item = document.getElementById('expenseItem').value;
            const price = parseFloat(document.getElementById('expensePrice').value);
            
            if(!item || !price) return alert('Ë´ãËº∏ÂÖ•È†ÖÁõÆËàáÈáëÈ°ç');

            expenses.unshift({
                id: Date.now(),
                item,
                price,
                img: currentExpenseImg,
                date: new Date().toLocaleDateString()
            });
            
            localStorage.setItem('trip_expenses', JSON.stringify(expenses));
            
            // Reset UI
            document.getElementById('expenseItem').value = '';
            document.getElementById('expensePrice').value = '';
            document.getElementById('imgPreviewArea').classList.add('hidden');
            currentExpenseImg = null;
            renderExpenses();
        }

        function deleteExpense(id) {
            if(confirm('Á¢∫ÂÆöÂà™Èô§?')) {
                expenses = expenses.filter(e => e.id !== id);
                localStorage.setItem('trip_expenses', JSON.stringify(expenses));
                renderExpenses();
            }
        }

        function renderExpenses() {
            const list = document.getElementById('expenseList');
            let html = '';
            let totalJ = 0;

            expenses.forEach(e => {
                totalJ += e.price;
                html += `
                    <div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center border border-gray-100">
                        <div class="flex items-center gap-3">
                            ${e.img ? `<div onclick="showFullImg('${e.img}')" class="w-10 h-10 bg-cover bg-center rounded bg-gray-200 flex-shrink-0" style="background-image:url(${e.img})"></div>` : `<div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center text-gray-400"><i class="fa-solid fa-yen-sign"></i></div>`}
                            <div>
                                <div class="font-bold text-sm">${e.item}</div>
                                <div class="text-xs text-gray-400">${e.date}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold">¬•${e.price}</div>
                            <div class="text-xs text-gray-400">NT$${Math.round(e.price * rate)}</div>
                            <button onclick="deleteExpense(${e.id})" class="text-gray-300 text-xs mt-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
            document.getElementById('totalJpy').innerText = totalJ.toLocaleString();
            document.getElementById('totalTwd').innerText = Math.round(totalJ * rate).toLocaleString();
        }
        
        function showFullImg(src) {
            const w = window.open("");
            w.document.write(`<img src="${src}" style="width:100%">`);
        }

        // --- LISTS MODULE ---
        let userChecklist = JSON.parse(localStorage.getItem('trip_checklist')) || {};
        let memoList = JSON.parse(localStorage.getItem('trip_memos')) || [];
        let shopList = JSON.parse(localStorage.getItem('trip_shop')) || [];

        function initLists() {
            renderPacking();
            renderMemo();
            renderShop();
        }

        function switchListTab(tab) {
            document.querySelectorAll('.list-tab-btn').forEach(b => {
                b.classList.remove('bg-muji-accent', 'text-white', 'border-muji-accent');
                b.classList.add('bg-white', 'text-gray-500', 'border-muji-border');
            });
            event.currentTarget.classList.remove('bg-white', 'text-gray-500', 'border-muji-border');
            event.currentTarget.classList.add('bg-muji-accent', 'text-white', 'border-muji-accent');

            document.querySelectorAll('.list-content').forEach(d => d.classList.add('hidden'));
            document.getElementById(`list-${tab}`).classList.remove('hidden');
        }

        function renderPacking() {
            const container = document.getElementById('list-packing');
            let html = '';
            for (const [category, items] of Object.entries(packingList)) {
                html += `<div class="mb-4"><h3 class="font-bold text-muji-accent mb-2">${category}</h3><div class="space-y-2">`;
                items.forEach(item => {
                    const isChecked = userChecklist[item] ? 'checked' : '';
                    const strike = userChecklist[item] ? 'line-through text-gray-400' : '';
                    html += `
                        <label class="flex items-center bg-white p-3 rounded shadow-sm border border-gray-100">
                            <input type="checkbox" class="w-5 h-5 accent-teal-700 mr-3" ${isChecked} onchange="toggleCheck('${item}')">
                            <span class="${strike}">${item}</span>
                        </label>
                    `;
                });
                html += `</div></div>`;
            }
            container.innerHTML = html;
        }

        function toggleCheck(item) {
            userChecklist[item] = !userChecklist[item];
            localStorage.setItem('trip_checklist', JSON.stringify(userChecklist));
            renderPacking();
        }

        // MEMO
        function saveMemo() {
            const txt = document.getElementById('memoInput').value;
            if(!txt) return;
            memoList.push({ id: Date.now(), text: txt });
            localStorage.setItem('trip_memos', JSON.stringify(memoList));
            document.getElementById('memoInput').value = '';
            renderMemo();
        }
        
        function renderMemo() {
            const c = document.getElementById('memoContainer');
            c.innerHTML = memoList.map(m => {
                // Auto-link regex
                const linkedText = m.text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 underline">$1</a>');
                return `
                <div class="bg-yellow-50 p-3 rounded shadow-sm border border-yellow-100 text-sm relative">
                    <button onclick="deleteMemo(${m.id})" class="absolute top-1 right-2 text-gray-400"><i class="fa-solid fa-xmark"></i></button>
                    <div class="whitespace-pre-wrap pr-4">${linkedText}</div>
                </div>`;
            }).join('');
        }

        function deleteMemo(id) {
            memoList = memoList.filter(m => m.id !== id);
            localStorage.setItem('trip_memos', JSON.stringify(memoList));
            renderMemo();
        }

        // SHOPPING
        function addShopItem() {
            const txt = document.getElementById('shopInput').value;
            if(!txt) return;
            shopList.push({ id: Date.now(), text: txt, bought: false });
            localStorage.setItem('trip_shop', JSON.stringify(shopList));
            document.getElementById('shopInput').value = '';
            renderShop();
        }

        function toggleShop(id) {
            const idx = shopList.findIndex(i => i.id === id);
            if(idx > -1) {
                shopList[idx].bought = !shopList[idx].bought;
                localStorage.setItem('trip_shop', JSON.stringify(shopList));
                renderShop();
            }
        }

        function renderShop() {
            const c = document.getElementById('shopContainer');
            c.innerHTML = shopList.map(item => `
                <div class="flex justify-between items-center bg-white p-3 rounded shadow-sm border border-gray-100">
                    <div class="flex items-center">
                        <button onclick="toggleShop(${item.id})" class="mr-3 text-xl ${item.bought ? 'text-green-500' : 'text-gray-300'}">
                            <i class="fa-solid ${item.bought ? 'fa-square-check' : 'fa-square'}"></i>
                        </button>
                        <span class="${item.bought ? 'line-through text-gray-400' : ''}">${item.text}</span>
                    </div>
                    ${item.bought ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Â∑≤Ë≥º</span>' : ''}
                </div>
            `).join('');
        }

        // --- INFO MODULE ---
        let qrCodes = JSON.parse(localStorage.getItem('trip_qrcodes')) || [];

        function initInfo() {
            renderHotels();
            renderQRs();
        }

        function renderHotels() {
            const c = document.getElementById('hotelInfo');
            c.innerHTML = hotels.map(h => `
                <div class="pb-2 border-b border-gray-100 last:border-0">
                    <div class="text-xs font-bold bg-gray-200 inline-block px-1 rounded text-gray-600 mb-1">${h.date}</div>
                    <div class="font-bold text-base text-muji-accent">${h.name}</div>
                    <div class="text-xs text-gray-500 mt-1">${h.address}</div>
                    <div class="flex gap-3 mt-2">
                         <button onclick="openMap('${h.address}')" class="text-blue-500 text-xs underline">Âú∞Âúñ</button>
                         ${h.tel ? `<a href="tel:${h.tel}" class="text-blue-500 text-xs underline">Êí•ÊâìÈõªË©±</a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function toggleAccordion(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }

        function addQRCode(input) {
             if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    qrCodes.push(e.target.result); // Save full Base64 (QR needs quality)
                    localStorage.setItem('trip_qrcodes', JSON.stringify(qrCodes));
                    renderQRs();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderQRs() {
            const c = document.getElementById('qrContainer');
            c.innerHTML = qrCodes.map((src, idx) => `
                <div class="relative group">
                    <img src="${src}" class="w-full rounded border border-gray-200" onclick="showFullImg('${src}')">
                    <button onclick="deleteQR(${idx})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-80"><i class="fa-solid fa-xmark"></i></button>
                </div>
            `).join('');
        }

        function deleteQR(idx) {
            if(confirm('Âà™Èô§Ê≠§ QR Code?')) {
                qrCodes.splice(idx, 1);
                localStorage.setItem('trip_qrcodes', JSON.stringify(qrCodes));
                renderQRs();
            }
        }

    </script>
</body>
</html>
