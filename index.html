<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÊªëÈõ™‰∏çË∑åÂÄí</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#fcfaf2',
                            card: '#ffffff',
                            text: '#4a4a4a',
                            accent: '#2c5d63',
                            secondary: '#8c8c8c',
                            border: '#e6e6e6',
                            highlight: '#d4493e',
                            planA: '#5c7c8a',
                            planB: '#c47c6e'
                        }
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles */
        body {
            background-color: #fcfaf2;
            color: #4a4a4a;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        .page-container {
            padding-bottom: 90px;
            min-height: 100vh;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .page-container.active {
            display: block;
            opacity: 1;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .muji-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            border: 1px solid #f0f0f0;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .muji-btn {
            background-color: #2c5d63;
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            transition: opacity 0.2s;
        }
        .muji-btn:active { opacity: 0.8; }

        .timeline-line {
            position: absolute;
            left: 24px;
            top: 20px;
            bottom: 0;
            width: 2px;
            background-color: #e5e5e5;
            z-index: 0;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            background-color: #2c5d63;
            border-radius: 50%;
            border: 2px solid white;
            z-index: 10;
            position: relative;
        }

        .muji-input {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            width: 100%;
            background: #fafafa;
            outline: none;
        }
        .muji-input:focus { border-color: #2c5d63; background: white; }

        /* FIXED STICKY HEADER */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 999;
            background-color: #2c5d63; 
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            padding-top: 10px;
        }
        
        .day-tabs-container {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 10px 16px;
            align-items: center;
        }
        
        .day-tab {
            flex: 0 0 auto;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .day-tab.active {
            background-color: white;
            color: #2c5d63;
            transform: scale(1.1);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Cover & Gallery */
        #cover-area {
            height: 180px;
            background-size: cover;
            background-position: center;
            background-color: #ddd;
            position: relative;
        }
        #cover-gradient {
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.4));
            position: absolute; top:0; left:0; right:0; bottom:0;
        }

        .weather-badge {
            display: inline-flex;
            align-items: center;
            background-color: #eef2f3;
            color: #555;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* Food Tabs */
        .food-tab-btn {
            white-space: nowrap;
            transition: all 0.2s;
        }
        .food-tab-btn.active {
            background-color: #2c5d63;
            color: white;
            border-color: #2c5d63;
            box-shadow: 0 2px 5px rgba(44, 93, 99, 0.2);
        }
    </style>
</head>
<body class="font-sans antialiased text-muji-text">

    <div id="app" class="max-w-md mx-auto relative bg-muji-bg min-h-screen shadow-2xl">

        <div id="cover-area" style="background-image: url('https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80');">
            <div id="cover-gradient"></div>
            <div class="absolute bottom-4 left-4 text-white z-10">
                <h1 class="text-2xl font-bold tracking-widest text-shadow">ÊªëÈõ™‰∏çË∑åÂÄí</h1>
                <div class="text-xs opacity-90" id="globalWeather">Today: Êù±‰∫¨ ‚õÖ 8¬∞C</div>
                <div class="text-[10px] bg-white/20 px-2 py-0.5 rounded inline-block mt-1">ÈòøÁéãÈòøÁúüÂ∞àÂ±¨Ë°åÁ®ã (5 Days)</div>
            </div>
            <label class="absolute bottom-4 right-4 bg-white/30 backdrop-blur-md p-2 rounded-full cursor-pointer hover:bg-white/50 z-20">
                <i class="fa-solid fa-camera text-white"></i>
                <input type="file" accept="image/*" class="hidden" onchange="changeCover(this)">
            </label>
        </div>
        
        <div id="page-plan" class="page-container active">
            
            <div class="sticky-header">
                <div class="day-tabs-container no-scrollbar" id="dayTabs"></div>
                <div class="text-center text-[10px] text-white/50 pb-1 cursor-pointer" onclick="window.scrollTo(0,0)">
                    <i class="fa-solid fa-caret-up"></i> ÈªûÊìäÂ§©Êï∏ÂàáÊèõ
                </div>
            </div>

            <div class="px-4 mt-4">
                <div id="day-content" class="min-h-[50vh] pb-6"></div>

                <div class="mb-6 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg text-muji-accent"><i class="fa-solid fa-images"></i> ÊóÖÈÄîÁõ∏Á∞ø</h3>
                        <label class="text-xs bg-gray-200 px-3 py-1 rounded-full cursor-pointer hover:bg-gray-300">
                            + Êñ∞Â¢ûÁÖßÁâá
                            <input type="file" accept="image/*" multiple class="hidden" onchange="handleAddDayPhotos(this)">
                        </label>
                    </div>
                    <div id="day-gallery-grid" class="grid grid-cols-3 gap-2">
                        </div>
                    <p class="text-[10px] text-gray-400 mt-2 text-center">ÁÖßÁâáÂÑ≤Â≠òÊñºÊâãÊ©üÁÄèË¶ΩÂô®‰∏≠</p>
                </div>

                <div class="flex justify-between mb-8 pt-4 border-t border-gray-200">
                    <button onclick="changeDayOffset(-1)" id="btnPrev" class="text-muji-secondary px-4 py-3 bg-white border border-gray-200 rounded-lg shadow-sm disabled:opacity-30 flex items-center transition-transform active:scale-95">
                        <i class="fa-solid fa-chevron-left mr-2"></i> ‰∏ä‰∏ÄÂ§©
                    </button>
                    <button onclick="changeDayOffset(1)" id="btnNext" class="text-white px-4 py-3 bg-muji-accent rounded-lg shadow-sm font-bold disabled:opacity-30 flex items-center transition-transform active:scale-95">
                        ‰∏ã‰∏ÄÂ§© <i class="fa-solid fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="page-food" class="page-container px-4 pt-4">
            <h2 class="text-2xl font-bold mb-2 text-muji-text">Food Guide</h2>
            
            <div class="flex space-x-2 mb-4 overflow-x-auto pb-2 no-scrollbar sticky top-0 bg-muji-bg z-30 pt-2" id="foodTabsContainer">
                </div>

            <div id="food-list" class="space-y-4"></div>
        </div>

        <div id="page-wallet" class="page-container px-4 pt-4">
            <h2 class="text-2xl font-bold mb-4 text-muji-text">Wallet</h2>
            <div class="muji-card p-4 mb-4 bg-white sticky top-0 z-30 shadow-md">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold text-muji-secondary">ÂåØÁéáÊèõÁÆó (1 JPY = <span id="displayRate">0.22</span> TWD)</span>
                    <i class="fa-solid fa-gear text-gray-300 cursor-pointer" onclick="toggleRateEdit()"></i>
                </div>
                <div id="rateEditor" class="hidden mb-2">
                    <input type="number" id="customRate" step="0.001" class="muji-input h-8 text-sm" placeholder="Ë®≠ÂÆöÂåØÁéá" onchange="updateRate()">
                </div>
                <div class="flex items-center space-x-2">
                    <div class="relative w-full">
                        <span class="absolute left-3 top-2.5 text-gray-400">¬•</span>
                        <input type="text" id="calcInput" class="muji-input pl-8 text-lg font-mono font-bold" placeholder="500+200">
                    </div>
                    <div class="text-2xl font-bold text-muji-accent">=</div>
                    <div class="text-right min-w-[80px]">
                        <div class="text-xs text-gray-400">NT$</div>
                        <div class="text-xl font-bold" id="twdResult">0</div>
                    </div>
                </div>
            </div>
            <div class="muji-card p-4 mb-6">
                <h3 class="text-sm font-bold mb-3 text-muji-accent">Êñ∞Â¢ûË®òÂ∏≥</h3>
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <input type="text" id="expenseItem" class="muji-input col-span-2" placeholder="ÂìÅÈ†ÖÂêçÁ®±">
                    <input type="number" id="expensePrice" class="muji-input" placeholder="¬•ÈáëÈ°ç">
                </div>
                <div class="flex justify-between items-center">
                    <label class="flex items-center space-x-2 cursor-pointer bg-gray-100 px-3 py-2 rounded-lg text-sm hover:bg-gray-200 transition">
                        <i class="fa-solid fa-camera text-muji-secondary"></i>
                        <input type="file" id="expenseImg" accept="image/*" class="hidden" onchange="handleImagePreview(this)">
                    </label>
                    <div id="imgPreviewArea" class="hidden w-8 h-8 rounded bg-cover bg-center border border-gray-300"></div>
                    <button onclick="addExpense()" class="muji-btn text-sm px-6">ÂÑ≤Â≠ò</button>
                </div>
            </div>
            <div id="expenseList" class="space-y-3 pb-10"></div>
        </div>

        <div id="page-lists" class="page-container px-4 pt-4">
             <div class="flex space-x-2 mb-4 overflow-x-auto pb-2" id="listTabs">
                <button onclick="switchListTab('packing')" class="list-tab-btn active px-4 py-2 rounded-full text-sm font-bold border border-muji-accent bg-muji-accent text-white">ÂøÖÂÇôÊ∏ÖÂñÆ</button>
                <button onclick="switchListTab('memo')" class="list-tab-btn px-4 py-2 rounded-full text-sm font-bold border border-muji-border bg-white text-gray-500">ÂÇôÂøòÈåÑ</button>
                <button onclick="switchListTab('shop')" class="list-tab-btn px-4 py-2 rounded-full text-sm font-bold border border-muji-border bg-white text-gray-500">Ë≥ºË≤∑Ê∏ÖÂñÆ</button>
            </div>
            <div id="list-packing" class="list-content"></div>
            <div id="list-memo" class="list-content hidden">
                <textarea id="memoInput" class="muji-input h-32 mb-2" placeholder="Ëº∏ÂÖ•ÂÇôÂøò‰∫ãÈ†Ö..."></textarea>
                <button onclick="saveMemo()" class="muji-btn w-full mb-4">Êñ∞Â¢û</button>
                <div id="memoContainer" class="space-y-3"></div>
            </div>
            <div id="list-shop" class="list-content hidden">
                <div class="flex flex-col space-y-2 mb-3">
                    <div class="flex space-x-2">
                        <input type="text" id="shopInput" class="muji-input" placeholder="ÊÉ≥Ë≤∑‰ªÄÈ∫º? Ëº∏ÂÖ•Á∂≤ÂùÄÊúÉËá™ÂãïËÆäÊàêÈÄ£Áµê">
                        
                        <label class="flex-shrink-0 flex items-center justify-center w-11 bg-white border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-muji-secondary">
                            <i class="fa-solid fa-camera"></i>
                            <input type="file" accept="image/*" class="hidden" onchange="handleShopImagePreview(this)">
                        </label>
                        
                        <button onclick="addShopItem()" class="muji-btn whitespace-nowrap">Êñ∞Â¢û</button>
                    </div>
                    
                    <div id="shopImgPreviewContainer" class="hidden relative w-fit">
                        <div id="shopImgPreview" class="w-16 h-16 rounded bg-cover bg-center border border-gray-300"></div>
                        <button onclick="clearShopImg()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-sm">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>

                 <div id="shopContainer" class="space-y-3"></div>
            </div>
        </div>

        <div id="page-info" class="page-container px-4 pt-4">
            <h2 class="text-2xl font-bold mb-4 text-muji-text">Info & Docs</h2>
            <div class="space-y-4">
                <div class="muji-card p-4">
                    <h3 class="font-bold mb-2 flex items-center"><i class="fa-solid fa-qrcode mr-2 text-muji-accent"></i> ÂÖ•Â¢É QR Code</h3>
                    <div class="grid grid-cols-2 gap-4" id="qrContainer"></div>
                    <label class="mt-3 block text-center border-2 border-dashed border-gray-300 rounded-lg p-2 cursor-pointer hover:bg-gray-50">
                        <span class="text-xs text-gray-500">+ ‰∏äÂÇ≥Êà™Âúñ</span>
                        <input type="file" accept="image/*" class="hidden" onchange="addQRCode(this)">
                    </label>
                </div>
                <div class="muji-card p-4 border-l-4 border-red-500">
                    <h3 class="font-bold text-red-600 mb-2">Á∑äÊÄ•ËÅØÁµ°</h3>
                    <ul class="text-sm space-y-2">
                        <li>üëÆ Ë≠¶ÂØü: 110 / üöë ÊïëË≠∑: 119</li>
                        <li>üáπüáº ÈßêÊó•‰ª£Ë°®Ëôï (Êù±‰∫¨): +81-3-3280-7811</li>
                    </ul>
                </div>
                <div class="muji-card">
                    <button class="w-full text-left p-4 font-bold flex justify-between items-center" onclick="toggleAccordion('hotelInfo')">
                        <span>üè® ‰ΩèÂÆøË≥áË®ä</span>
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </button>
                    <div id="hotelInfo" class="hidden px-4 pb-4 text-sm space-y-4 border-t border-gray-100 pt-2"></div>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 flex justify-around items-center py-2 z-50 pb-safe">
            <button onclick="navTo('plan')" class="nav-btn active flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-regular fa-calendar-days text-xl mb-1"></i><span class="text-[10px]">Ë°åÁ®ã</span>
            </button>
            <button onclick="navTo('food')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-utensils text-xl mb-1"></i><span class="text-[10px]">È£üË®ò</span>
            </button>
            <button onclick="navTo('wallet')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px]">Ë®òÂ∏≥</span>
            </button>
            <button onclick="navTo('lists')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-list-check text-xl mb-1"></i><span class="text-[10px]">Ê∏ÖÂñÆ</span>
            </button>
            <button onclick="navTo('info')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-circle-info text-xl mb-1"></i><span class="text-[10px]">Ë≥áË®ä</span>
            </button>
        </nav>

    </div>

    <script>
        // --- 5 DAY ITINERARY FOR AH WANG & AH ZHEN ---
        const itinerary = [
            { day: 1, date: "2/24 (‰∫å)", title: "ÊäµÈÅî & ÁßªÂãïËºï‰∫ïÊæ§", icon: "fa-plane", weather: { text: "Êù±‰∫¨ Êô¥ 5~11¬∞C", icon: "fa-sun", link: "Tokyo" }, events: [{ time: "06:40", title: "ÈÖ∑Ëà™ TR898 Âá∫Áôº", note: "Á¨¨‰∏ÄËà™Âªà", type: "flight" }, { time: "10:45", title: "ÊäµÈÅîÊàêÁî∞Ê©üÂ†¥", type: "flight" }, { time: "11:13~", title: "Êê≠ËªäÂâçÂæÄ‰∏äÈáé", note: "ËªäÁ®ã50ÂàÜ", type: "train" }, { time: "12:00", title: "‰∏äÈáéÂçàÈ§ê", type: "food" }, { time: "15:10", title: "Êñ∞ÂππÁ∑ö -> Ëºï‰∫ïÊæ§", note: "‰∏äÈáéÂá∫Áôº", type: "train", highlight: true }, { time: "16:30", title: "ÁßüÈõ™ÂÖ∑", address: "4-8 KARUIZAWAHIGASHI", type: "activity" }, { time: "18:00", title: "ÊôöÈ§ê", type: "food" }] },
            { day: 2, date: "2/25 (‰∏â)", title: "ÊªëÈõ™Êó•", icon: "fa-person-skiing", weather: { text: "Ëºï‰∫ïÊæ§ Èõ™ -2~3¬∞C", icon: "fa-snowflake", link: "Nagano/Karuizawa" }, events: [{ time: "All Day", title: "ÊªëÈõ™", note: "Ëºï‰∫ïÊæ§ÊªëÈõ™Â†¥", type: "activity" }] },
            { day: 3, date: "2/26 (Âõõ)", title: "ÊªëÈõ™ & ÁßüËªä", icon: "fa-person-skiing", weather: { text: "Ëºï‰∫ïÊæ§ Èõ™ -3~2¬∞C", icon: "fa-snowflake", link: "Nagano/Karuizawa" }, events: [{ time: "09:00", title: "ÊªëÈõ™", note: "Ëá≥ 16:00", type: "activity" }, { time: "17:00", title: "ÁßüËªä", type: "car", highlight: true }] },
            { day: 4, date: "2/27 (‰∫î)", title: "Ëºï‰∫ïÊæ§ËßÄÂÖâ & ÂõûÊù±‰∫¨", icon: "fa-camera", weather: { text: "Ëºï‰∫ïÊæ§ Èô∞ 0~5¬∞C", icon: "fa-cloud", link: "Nagano/Karuizawa" }, events: [{ time: "09:30", title: "Ê¶ÜÊ®πË°óÂ∞èÈéÆ", type: "sight" }, { time: "11:00", title: "Èõ≤Â†¥Ê±†", type: "sight" }, { time: "13:57", title: "Êñ∞ÂππÁ∑öÂõû‰∏äÈáé", type: "train", highlight: true }, { time: "18:00", title: "‰∏äÈáéÊôöÈ§ê", type: "food" }] },
            { day: 5, date: "2/28 (ÂÖ≠)", title: "Êù±‰∫¨ÈÄõË°ó & ËøîÂè∞", icon: "fa-plane-departure", weather: { text: "Êù±‰∫¨ Êô¥ 6~12¬∞C", icon: "fa-sun", link: "Tokyo" }, events: [
                { time: "09:30", title: "Â¶ôÁæ©Á•ûÁ§æ", address: "3 Chome-16-16 Komagome", type: "sight" }, 
                { time: "10:30", title: "Ê±†Ë¢ãÂ§™ÈôΩÂüé", type: "shop" }, 
                { time: "13:30", title: "ÊäµÈÅî‰∏äÈáé/Êó•ÊöÆÈáå", type: "train" },
                { time: "14:20", title: "Skyliner ÂâçÂæÄÊ©üÂ†¥", note: "ÂâçÂæÄÊàêÁî∞Ê©üÂ†¥", type: "train", highlight: true },
                { time: "17:45", title: "‰∏≠ËèØËà™Á©∫ Ëµ∑È£õ", note: "20:55 ÊäµÈÅîÂè∞ÁÅ£", type: "flight", highlight: true }
            ]}
        ];

        // --- Data (Filtered for 5 Days) ---
        const hotels = [
            { name: "Ëºï‰∫ïÊæ§ÁéãÂ≠êÈ£ØÂ∫óË•øÈ§®", date: "2/24-2/27", address: "389-0193 Èï∑ÈáéÁ∏£Âåó‰Ωê‰πÖÈÉ°Ëºï‰∫ïÊæ§Áî∫Ëºï‰∫ïÊæ§1016-85", tel: "+81-(0)267-42-1113" },
            { name: "LANDABOUT TOKYO", date: "2/27-2/28", address: "Êù±‰∫¨ÈÉΩ, Êù±‰∫¨, Taito-ku Negishi 3-4-5", tel: "+81-3-6802-4437" }
        ];
        
        const packingList = {
            "ÂÄã‰∫∫Áâ©ÂìÅ": ["Ë≠∑ÁÖß", "‰ø°Áî®Âç°", "Ë∫´ÂàÜË≠â", "ÁèæÈáë", "Ë∫´ÂàÜË≠âÂΩ±Êú¨", "Ë≠∑ÁÖßÂΩ±Êú¨", "ÈßïÁÖß", "ÂúãÈöõÈßïÁÖß", "ÈßïÁÖßË≠ØÊú¨"],
            "ÈõúÁâ©": ["Ë°£Áâ©", "Â∏ΩÂ≠ê", "Â§™ÈôΩÁúºÈè°", "Èö±Áúº", "Ê¢≥Â≠ê", "‰øùÈ§äÂìÅ", "Ëó•ÂìÅ"],
            "ÈõªÂ≠êÁî¢ÂìÅ": ["ÂÖÖÈõªÂô®", "ÂÖÖÈõªÁ∑ö", "Ë°åÂãïÈõªÊ∫ê", "Ëê¨ÂúãÊèíÂ∫ß", "GoPro", "ÈõªÊ±†/Ë®òÊÜ∂Âç°", "Á∂≤Âç°"],
            "ÊªëÈõ™Ê∫ñÂÇô": ["Èõ™Èè°", "ÊéíÊ±óË°£", "‰øùÊöñÈï∑Ë¢ñ", "ÊâãÂ•ó", "Èï∑Ë•™", "Èò≤ÊªëÈûã", "Â±ÅÂ¢ä", "ÊöñÊöñÂåÖ", "Ë≠∑ËÜù", "Ë≠∑Êâã", "ÂÜ∞Áà™"]
        };
        
        // --- Updated Food Data ---
        const foodData = [
            {
                id: "d1-lunch",
                label: "D1 ‰∏äÈáéÂçàÈ§ê",
                area: "Êù±‰∫¨‰∏äÈáé",
                spots: [
                    { name: "ËüπÈ£üÊîæÈ°å „Åî„Å£„Å§„Åä", type: "ÂêÉÂà∞È£Ω", address: "https://maps.app.goo.gl/Rp6dMS3VGsW6yh9K8", tel: "", note: "ËûÉËüπÂêÉÂà∞È£Ω" },
                    { name: "Êù±‰∫¨ÁÇ∏Ë±¨Êéí „Åå„Å∂„ÅÜ", type: "Ë±¨Êéí", address: "https://maps.app.goo.gl/pg8YiKhQ7DvFyB6p9", tel: "", note: "" },
                    { name: "Â§©Â©¶ÁæÖ Â§©ÂØø„Çû", type: "Â§©Â©¶ÁæÖ", address: "https://maps.app.goo.gl/1UPZHjPUsC9de1UQA", tel: "", note: "" },
                    { name: "ÈáëÊ≤¢„Åæ„ÅÑ„ÇÇ„ÇìÂØøÂè∏", type: "Â£ΩÂè∏", address: "https://maps.app.goo.gl/VPMDuMSszPCgQpFV6", tel: "", note: "Ëø¥ËΩâÂ£ΩÂè∏" }
                ]
            },
            {
                id: "d1-d3-dinner",
                label: "D1-3 Ëºï‰∫ïÊæ§ÊôöÈ§ê",
                area: "Ëºï‰∫ïÊæ§",
                spots: [
                    { name: "„Åó„ÇÉ„Å∂„Åó„ÇÉ„Å∂ÊÑõÂÆï", type: "Ê∂ÆÊ∂ÆÈçã", address: "https://maps.app.goo.gl/uGzDhdyx7qHgRKyy5", tel: "0267-41-6111", note: "" },
                    { name: "„Ç¢„ÇØ„Çª„Çπ (Access)", type: "È§êÂª≥", address: "https://maps.app.goo.gl/sYZRLBTJ7d3M66Wd6", tel: "0267-42-3081", note: "" },
                    { name: "ÊùëÊ∞ëÈ£üÂ†Ç", type: "Êó•ÂºèÂÆöÈ£ü", address: "https://maps.app.goo.gl/kaefExA2mjnSSkpd8", tel: "0267-44-3571", note: "ÊòüÈáéÂçÄ" },
                    { name: "„Çç„Åê‰∫≠ÁáíËÇâ", type: "ÁáíËÇâ", address: "https://maps.app.goo.gl/qbN35Ey3FKH4e9YW9", tel: "0267-45-2341", note: "Êú®Â±ãÁáíËÇâ" },
                    { name: "Fujiya", type: "Ë•øÂºè", address: "https://maps.app.goo.gl/e3EARNFtAoGALaid9", tel: "", note: "Á∂ìÂÖ∏È£ØÂ∫óÈ§êÂª≥" },
                    { name: "Primo Fito", type: "Áæ©Âºè", address: "https://maps.app.goo.gl/C4WtRCwJ9JHAnzLr5", tel: "", note: "" }
                ]
            },
            {
                id: "d4-dinner",
                label: "D4 ‰∏äÈáéÊôöÈ§ê",
                area: "Êù±‰∫¨‰∏äÈáé",
                spots: [
                    { name: "‰∏âÊµ¶‰∏âÂ¥éÊ∏ØËø¥ËΩâÂ£ΩÂè∏", type: "Â£ΩÂè∏", address: "https://maps.app.goo.gl/VJXgERqoWoxW7uAa9", tel: "", note: "" },
                    { name: "„ÅΩ„ÇìÂ§öÊú¨ÂÆ∂ Ë±¨Êéí", type: "Ë±¨Êéí", address: "https://maps.app.goo.gl/4W1kfAtLvaYV6bqeA", tel: "", note: "ËÄÅÂ∫ó" },
                    { name: "‰∏äÈáéÂÖîÂ±ã ÈäÖÈëºÁáí", type: "ÁîúÈªû", address: "https://maps.app.goo.gl/3wWrCgXUDpZkRApn6", tel: "", note: "" },
                    { name: "EGG BABY CAF√â", type: "ÂíñÂï°Âª≥", address: "https://maps.app.goo.gl/YGDFKHrPwm7JcBGu6", tel: "", note: "ÂçäÁÜüËõã‰∏âÊòéÊ≤ª" },
                    { name: "TORIE UENO HIRO KOJI TEN", type: "ÁáíÈ≥•", address: "https://maps.app.goo.gl/DGbWb1ibo8DTaD6J7", tel: "", note: "‰∏≤Ááí" }
                ]
            }
        ];

        // --- Core Logic ---
        let currentDayIndex = 0;
        let dayPhotos = JSON.parse(localStorage.getItem('ahwang_trip_photos')) || {}; 

        document.addEventListener('DOMContentLoaded', () => {
            renderDayTabs();
            jumpToDay(0);
            initFood();
            initWallet();
            initLists();
            initInfo();
            loadCover();
            updateGlobalWeather();
        });

        function updateGlobalWeather() {
            const d = new Date();
            const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
            document.getElementById('globalWeather').innerHTML = `${dateStr} Êù±‰∫¨ ‚õÖ 8¬∞C`;
        }

        // --- NAVIGATION ---
        function renderDayTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = itinerary.map((day, idx) => `
                <div onclick="jumpToDay(${idx})" class="day-tab ${idx === 0 ? 'active' : ''}" id="tab-${idx}">
                    D${day.day}
                </div>
            `).join('');
        }

        function jumpToDay(index) {
            index = parseInt(index, 10);
            if (isNaN(index) || index < 0) index = 0;
            if (index >= itinerary.length) index = itinerary.length - 1;
            
            currentDayIndex = index;
            renderDay(index);
            window.scrollTo(0, 0);
        }

        function changeDayOffset(offset) {
            jumpToDay(currentDayIndex + offset);
        }

        function renderDay(index) {
            const day = itinerary[index];
            const container = document.getElementById('day-content');

            // Tabs Styling
            document.querySelectorAll('.day-tab').forEach((el, idx) => {
                if(idx === index) {
                    el.classList.add('active');
                    el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    el.classList.remove('active');
                }
            });

            // Buttons
            document.getElementById('btnPrev').disabled = (index === 0);
            document.getElementById('btnPrev').style.opacity = (index === 0) ? '0.3' : '1';
            document.getElementById('btnNext').disabled = (index === itinerary.length - 1);
            document.getElementById('btnNext').style.opacity = (index === itinerary.length - 1) ? '0.3' : '1';

            // Events
            let eventsHtml = '';
            day.events.forEach(evt => {
                if (evt.type === 'html') {
                    eventsHtml += `<div class="relative pl-8 pb-4"><div class="timeline-dot absolute left-[22px] top-1"></div>${evt.content}</div>`;
                } else {
                    const highlightClass = evt.highlight ? 'text-muji-highlight font-bold' : '';
                    const borderClass = evt.highlight ? 'border-l-4 border-muji-highlight pl-2' : '';
                    const mapBtn = evt.address ? `<button onclick="openMap('${evt.address}')" class="ml-2 text-muji-accent"><i class="fa-solid fa-location-dot"></i></button>` : '';
                    eventsHtml += `
                        <div class="relative pl-8 pb-6 last:pb-0">
                            <div class="timeline-dot absolute left-[22px] top-1"></div>
                            <div class="text-sm font-bold text-muji-accent">${evt.time}</div>
                            <div class="bg-white p-3 rounded-lg shadow-sm mt-1 border border-gray-100 ${borderClass}">
                                <div class="font-medium text-base ${highlightClass}">${evt.title} ${mapBtn}</div>
                                ${evt.note ? `<div class="text-xs text-gray-500 mt-1">${evt.note}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            });

            const weatherHtml = `
                <div class="weather-badge mb-2 shadow-sm border border-gray-100">
                    <i class="fa-solid ${day.weather.icon} mr-2 text-blue-500"></i> ${day.weather.text}
                    <button onclick="openWeather('${day.weather.link}')" class="ml-2 text-gray-400 hover:text-blue-600 border-l pl-2 border-gray-300"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                </div>
            `;

            container.innerHTML = `
                <div class="animate-fade-in">
                    <div class="relative mb-8">
                        <div class="timeline-line"></div>
                        <div class="mb-4 bg-muji-bg z-20 pt-2">
                            <div class="flex justify-between items-end">
                                <h3 class="font-bold text-2xl text-muji-text">${day.date}</h3>
                                ${weatherHtml}
                            </div>
                            <div class="text-sm text-gray-500 flex items-center gap-2 mb-1">
                                <i class="fa-solid ${day.icon}"></i> ${day.title}
                            </div>
                        </div>
                        <div class="mt-2">
                            ${eventsHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // Render Photos
            renderDayPhotos(index);
            container.animate([{ opacity: 0, transform: 'translateY(5px)' }, { opacity: 1, transform: 'translateY(0)' }], { duration: 250, easing: 'ease-out' });
        }

        // --- DAY PHOTO LOGIC ---
        function handleAddDayPhotos(input) {
            if (input.files) {
                const files = Array.from(input.files);
                const dayIdx = currentDayIndex.toString();
                if(!dayPhotos[dayIdx]) dayPhotos[dayIdx] = [];

                let processedCount = 0;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const MAX_WIDTH = 300;
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                            dayPhotos[dayIdx].push(dataUrl);
                            processedCount++;
                            if(processedCount === files.length) {
                                localStorage.setItem('ahwang_trip_photos', JSON.stringify(dayPhotos));
                                renderDayPhotos(currentDayIndex);
                            }
                        }
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        function renderDayPhotos(idx) {
            const container = document.getElementById('day-gallery-grid');
            const photos = dayPhotos[idx.toString()] || [];
            if(photos.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center text-gray-300 text-sm py-4">Â∞öÁÑ°ÁÖßÁâá</div>';
                return;
            }
            container.innerHTML = photos.map((src, photoIdx) => `
                <div class="relative group aspect-square">
                    <div class="w-full h-full bg-cover bg-center rounded-lg border border-gray-100 shadow-sm" style="background-image: url(${src})" onclick="showFullImg('${src}')"></div>
                    <button onclick="deleteDayPhoto(${idx}, ${photoIdx})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center opacity-80 shadow"><i class="fa-solid fa-xmark"></i></button>
                </div>
            `).join('');
        }

        function deleteDayPhoto(dayIdx, photoIdx) {
            if(confirm('Âà™Èô§ÈÄôÂºµÁÖßÁâáÔºü')) {
                dayPhotos[dayIdx].splice(photoIdx, 1);
                localStorage.setItem('ahwang_trip_photos', JSON.stringify(dayPhotos));
                renderDayPhotos(dayIdx);
            }
        }

        // --- Helpers ---
        function navTo(pageId) {
            document.querySelectorAll('.page-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => { el.classList.remove('text-muji-accent'); el.classList.add('text-muji-secondary'); });
            event.currentTarget.classList.remove('text-muji-secondary'); event.currentTarget.classList.add('text-muji-accent');
            window.scrollTo(0,0);
        }
        function openMap(loc) { 
            if(!loc) return;
            if(loc.startsWith('http')) {
                window.open(loc, '_blank');
            } else {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank'); 
            }
        }
        function openWeather(loc) { window.open(`https://www.google.com/search?q=weather+${loc}+japan`, '_blank'); }
        function loadCover() { const s = localStorage.getItem('ahwang_trip_cover'); if(s) document.getElementById('cover-area').style.backgroundImage = `url(${s})`; }
        function changeCover(input) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload = function (e) { const img = new Image(); img.src = e.target.result; img.onload = function() { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const s = 800/img.width; c.width = 800; c.height = img.height * s; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const d = c.toDataURL('image/jpeg', 0.7); document.getElementById('cover-area').style.backgroundImage = `url(${d})`; localStorage.setItem('ahwang_trip_cover', d); }}; r.readAsDataURL(input.files[0]); }}

        // --- Wallet Logic ---
        let rate = localStorage.getItem('trip_rate') || 0.22;
        let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];
        function initWallet() { document.getElementById('displayRate').innerText = rate; document.getElementById('calcInput').addEventListener('input', calculate); renderExpenses(); }
        function toggleRateEdit() { document.getElementById('rateEditor').classList.toggle('hidden'); }
        function updateRate() { const val = parseFloat(document.getElementById('customRate').value); if(val) { rate = val; localStorage.setItem('trip_rate', rate); document.getElementById('displayRate').innerText = rate; calculate(); renderExpenses(); toggleRateEdit(); } }
        function calculate() { const input = document.getElementById('calcInput').value; try { if(input.match(/^[0-9+\-*/.() ]+$/)) { const jpy = new Function('return ' + input)(); document.getElementById('twdResult').innerText = Math.round(jpy * rate).toLocaleString(); } } catch(e) {} }
        let currentExpenseImg = null;
        function handleImagePreview(input) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload = function (e) { const img = new Image(); img.src = e.target.result; img.onload = function() { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const s = 400/img.width; c.width = 400; c.height = img.height * s; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); currentExpenseImg = c.toDataURL('image/jpeg', 0.6); document.getElementById('imgPreviewArea').style.backgroundImage = `url(${currentExpenseImg})`; document.getElementById('imgPreviewArea').classList.remove('hidden'); }}; r.readAsDataURL(input.files[0]); }}
        function addExpense() { const item = document.getElementById('expenseItem').value; const price = parseFloat(document.getElementById('expensePrice').value); if(!item || !price) return alert('Ë´ãËº∏ÂÖ•È†ÖÁõÆËàáÈáëÈ°ç'); expenses.unshift({ id: Date.now(), item, price, img: currentExpenseImg, date: new Date().toLocaleDateString() }); localStorage.setItem('trip_expenses', JSON.stringify(expenses)); document.getElementById('expenseItem').value = ''; document.getElementById('expensePrice').value = ''; document.getElementById('imgPreviewArea').classList.add('hidden'); currentExpenseImg = null; renderExpenses(); }
        function deleteExpense(id) { if(confirm('Á¢∫ÂÆöÂà™Èô§?')) { expenses = expenses.filter(e => e.id !== id); localStorage.setItem('trip_expenses', JSON.stringify(expenses)); renderExpenses(); } }
        function renderExpenses() { const list = document.getElementById('expenseList'); list.innerHTML = expenses.map(e => `<div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center border border-gray-100"><div class="flex items-center gap-3">${e.img ? `<div onclick="showFullImg('${e.img}')" class="w-10 h-10 bg-cover bg-center rounded bg-gray-200 flex-shrink-0" style="background-image:url(${e.img})"></div>` : `<div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center text-gray-400"><i class="fa-solid fa-yen-sign"></i></div>`}<div><div class="font-bold text-sm">${e.item}</div><div class="text-xs text-gray-400">${e.date}</div></div></div><div class="text-right"><div class="font-bold">¬•${e.price}</div><div class="text-xs text-gray-400">NT$${Math.round(e.price * rate)}</div><button onclick="deleteExpense(${e.id})" class="text-gray-300 text-xs mt-1"><i class="fa-solid fa-trash"></i></button></div></div>`).join(''); }
        function showFullImg(src) { const w = window.open(""); w.document.write(`<img src="${src}" style="width:100%">`); }

        // --- Lists Logic ---
        let userChecklist = JSON.parse(localStorage.getItem('trip_checklist')) || {};
        let memoList = JSON.parse(localStorage.getItem('trip_memos')) || [];
        let shopList = JSON.parse(localStorage.getItem('trip_shop')) || [];
        
        // Shop Image Temp Variable
        let currentShopImg = null;

        function initLists() { renderPacking(); renderMemo(); renderShop(); }
        function switchListTab(tab) { document.querySelectorAll('.list-tab-btn').forEach(b => { b.classList.remove('bg-muji-accent', 'text-white', 'border-muji-accent'); b.classList.add('bg-white', 'text-gray-500', 'border-muji-border'); }); event.currentTarget.classList.remove('bg-white', 'text-gray-500', 'border-muji-border'); event.currentTarget.classList.add('bg-muji-accent', 'text-white', 'border-muji-accent'); document.querySelectorAll('.list-content').forEach(d => d.classList.add('hidden')); document.getElementById(`list-${tab}`).classList.remove('hidden'); }
        function renderPacking() { let html = ''; for (const [category, items] of Object.entries(packingList)) { html += `<div class="mb-4"><h3 class="font-bold text-muji-accent mb-2">${category}</h3><div class="space-y-2">` + items.map(item => `<label class="flex items-center bg-white p-3 rounded shadow-sm border border-gray-100"><input type="checkbox" class="w-5 h-5 accent-teal-700 mr-3" ${userChecklist[item] ? 'checked' : ''} onchange="toggleCheck('${item}')"><span class="${userChecklist[item] ? 'line-through text-gray-400' : ''}">${item}</span></label>`).join('') + `</div></div>`; } document.getElementById('list-packing').innerHTML = html; }
        function toggleCheck(item) { userChecklist[item] = !userChecklist[item]; localStorage.setItem('trip_checklist', JSON.stringify(userChecklist)); renderPacking(); }
        function saveMemo() { const txt = document.getElementById('memoInput').value; if(txt) { memoList.push({ id: Date.now(), text: txt }); localStorage.setItem('trip_memos', JSON.stringify(memoList)); document.getElementById('memoInput').value = ''; renderMemo(); } }
        function renderMemo() { document.getElementById('memoContainer').innerHTML = memoList.map(m => `<div class="bg-yellow-50 p-3 rounded shadow-sm border border-yellow-100 text-sm relative"><button onclick="deleteMemo(${m.id})" class="absolute top-1 right-2 text-gray-400"><i class="fa-solid fa-xmark"></i></button><div class="whitespace-pre-wrap pr-4">${m.text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 underline">$1</a>')}</div></div>`).join(''); }
        function deleteMemo(id) { memoList = memoList.filter(m => m.id !== id); localStorage.setItem('trip_memos', JSON.stringify(memoList)); renderMemo(); }
        
        // --- Shopping List Logic (Updated with Images) ---
        function handleShopImagePreview(input) {
            if (input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = function (e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        // Resize Logic (Reuse same logic to save space)
                        const c = document.createElement('canvas');
                        const ctx = c.getContext('2d');
                        const s = 400/img.width; // Limit width to 400px
                        c.width = 400;
                        c.height = img.height * s;
                        ctx.drawImage(img, 0, 0, c.width, c.height);
                        
                        currentShopImg = c.toDataURL('image/jpeg', 0.6);
                        
                        // Show Preview
                        const preview = document.getElementById('shopImgPreview');
                        preview.style.backgroundImage = `url(${currentShopImg})`;
                        document.getElementById('shopImgPreviewContainer').classList.remove('hidden');
                    }
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        function clearShopImg() {
            currentShopImg = null;
            document.getElementById('shopImgPreviewContainer').classList.add('hidden');
        }

        function addShopItem() { 
            const txt = document.getElementById('shopInput').value; 
            if(txt || currentShopImg) { // Allow adding if only image exists too
                let type = 'text'; 
                let meta = ''; 
                // Detect link
                if (txt) {
                    const match = txt.match(/(https?:\/\/[^\s]+)/g); 
                    if(match) { 
                        type = 'link'; 
                        try { meta = new URL(match[0]).hostname; } catch(e) { meta = 'Link'; } 
                    }
                }
                
                shopList.push({ 
                    id: Date.now(), 
                    text: txt || "ÂúñÁâáÈ†ÖÁõÆ", // Default text if only image
                    bought: false, 
                    type: type, 
                    meta: meta,
                    img: currentShopImg 
                }); 
                
                localStorage.setItem('trip_shop', JSON.stringify(shopList)); 
                
                // Reset UI
                document.getElementById('shopInput').value = ''; 
                clearShopImg();
                
                renderShop(); 
            } 
        }

        function toggleShop(id) { const idx = shopList.findIndex(i => i.id === id); if(idx > -1) { shopList[idx].bought = !shopList[idx].bought; localStorage.setItem('trip_shop', JSON.stringify(shopList)); renderShop(); } }
        function deleteShopItem(id) { if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§È†ÖÁõÆ?')) { shopList = shopList.filter(i => i.id !== id); localStorage.setItem('trip_shop', JSON.stringify(shopList)); renderShop(); } }
        
        function renderShop() { 
            document.getElementById('shopContainer').innerHTML = shopList.map(item => { 
                let content = '';
                
                // Link Rendering
                if(item.type === 'link') {
                     content += `<div class="flex-1 min-w-0"><a href="${item.text.match(/(https?:\/\/[^\s]+)/)[0]}" target="_blank" class="block bg-gray-50 border border-gray-200 rounded p-2 mb-1 hover:bg-gray-100"><div class="flex items-center"><div class="w-8 h-8 bg-blue-100 text-blue-500 rounded flex items-center justify-center mr-2 shrink-0"><i class="fa-solid fa-link"></i></div><div class="overflow-hidden"><div class="text-xs font-bold text-gray-500 uppercase truncate">${item.meta}</div><div class="text-sm text-blue-600 truncate">${item.text}</div></div></div></a></div>`;
                } else {
                     content += `<span class="${item.bought ? 'line-through text-gray-400' : ''} flex-1 min-w-0 break-words">${item.text}</span>`;
                }

                // Image Rendering (New)
                let imgHtml = '';
                if (item.img) {
                    imgHtml = `<div onclick="showFullImg('${item.img}')" class="w-12 h-12 bg-cover bg-center rounded ml-3 border border-gray-200 shrink-0 cursor-pointer" style="background-image:url(${item.img})"></div>`;
                }

                return `
                    <div class="flex items-start bg-white p-3 rounded shadow-sm border border-gray-100 group">
                        <button onclick="toggleShop(${item.id})" class="mr-3 mt-1 text-xl ${item.bought ? 'text-green-500' : 'text-gray-300'} flex-shrink-0">
                            <i class="fa-solid ${item.bought ? 'fa-square-check' : 'fa-square'}"></i>
                        </button>
                        ${content}
                        ${imgHtml}
                        ${item.bought ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded ml-2 whitespace-nowrap self-start mt-1">Â∑≤Ë≥º</span>' : ''}
                        <button onclick="deleteShopItem(${item.id})" class="ml-2 mt-1 text-gray-300 hover:text-red-500 p-1 flex-shrink-0">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>`; 
            }).join(''); 
        }

        // --- Info & Food Logic (Updated) ---
        let qrCodes = JSON.parse(localStorage.getItem('trip_qrcodes')) || [];
        function initInfo() { renderHotels(); renderQRs(); }
        function renderHotels() { document.getElementById('hotelInfo').innerHTML = hotels.map(h => `<div class="pb-2 border-b border-gray-100 last:border-0"><div class="text-xs font-bold bg-gray-200 inline-block px-1 rounded text-gray-600 mb-1">${h.date}</div><div class="font-bold text-base text-muji-accent">${h.name}</div><div class="text-xs text-gray-500 mt-1">${h.address}</div><div class="flex gap-3 mt-2"><button onclick="openMap('${h.address}')" class="text-blue-500 text-xs underline">Âú∞Âúñ</button>${h.tel ? `<a href="tel:${h.tel}" class="text-blue-500 text-xs underline">Êí•ÊâìÈõªË©±</a>` : ''}</div></div>`).join(''); }
        function toggleAccordion(id) { document.getElementById(id).classList.toggle('hidden'); }
        function addQRCode(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function (e) { qrCodes.push(e.target.result); localStorage.setItem('trip_qrcodes', JSON.stringify(qrCodes)); renderQRs(); }; reader.readAsDataURL(input.files[0]); } }
        function renderQRs() { document.getElementById('qrContainer').innerHTML = qrCodes.map((src, idx) => `<div class="relative group"><img src="${src}" class="w-full rounded border border-gray-200" onclick="showFullImg('${src}')"><button onclick="deleteQR(${idx})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-80"><i class="fa-solid fa-xmark"></i></button></div>`).join(''); }
        function deleteQR(idx) { if(confirm('Âà™Èô§?')) { qrCodes.splice(idx, 1); localStorage.setItem('trip_qrcodes', JSON.stringify(qrCodes)); renderQRs(); } }

        // --- New Food Logic with Tabs ---
        let currentFoodTab = "d1-lunch";

        function initFood() { 
            // 1. Render Tabs
            const tabsContainer = document.getElementById('foodTabsContainer');
            tabsContainer.innerHTML = foodData.map(group => `
                <button onclick="switchFoodTab('${group.id}')" 
                        id="food-btn-${group.id}"
                        class="food-tab-btn px-4 py-2 rounded-full text-sm font-bold border border-muji-border bg-white text-gray-500 mr-2 last:mr-0">
                    ${group.label}
                </button>
            `).join('');

            // 2. Initial Render
            switchFoodTab(currentFoodTab);
        }

        function switchFoodTab(id) {
            currentFoodTab = id;
            
            // Update Buttons State
            document.querySelectorAll('.food-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-muji-accent', 'text-white');
                btn.classList.add('bg-white', 'text-gray-500', 'border-muji-border');
            });
            const activeBtn = document.getElementById(`food-btn-${id}`);
            if(activeBtn) {
                activeBtn.classList.remove('bg-white', 'text-gray-500', 'border-muji-border');
                activeBtn.classList.add('active', 'border-muji-accent', 'text-white');
            }

            // Render Content
            const selectedGroup = foodData.find(g => g.id === id);
            if(!selectedGroup) return;

            let html = `
                <div class="animate-fade-in">
                    <div class="flex justify-between items-end mb-3 border-b border-gray-200 pb-2">
                        <div class="text-xs text-gray-400"><i class="fa-solid fa-map-location-dot"></i> ${selectedGroup.area}</div>
                    </div>
            `;
            
            selectedGroup.spots.forEach(spot => {
                 // Check if address is a link
                 const isLink = spot.address && spot.address.startsWith('http');
                 const displayAddress = isLink ? 'üìç ÈªûÊìäÂè≥ÂÅ¥Â∞éËà™' : spot.address;

                 html += `
                    <div class="muji-card p-0 flex flex-col">
                        <div class="p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="text-xs font-bold bg-orange-100 text-orange-600 px-2 py-0.5 rounded">${spot.type}</span>
                                    <h4 class="font-bold text-lg mt-1 text-muji-text">${spot.name}</h4>
                                </div>
                                <button onclick="openMap('${spot.address}')" class="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-100 transition">
                                    <i class="fa-solid fa-location-arrow text-sm"></i>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-2"><i class="fa-solid fa-map-pin mr-1 w-4 text-center"></i> ${displayAddress}</p>
                            ${spot.tel ? `<p class="text-sm text-gray-500 mt-1"><a href="tel:${spot.tel}" class="hover:text-muji-accent"><i class="fa-solid fa-phone mr-1 w-4 text-center"></i> ${spot.tel}</a></p>` : ''}
                            ${spot.note ? `<div class="mt-3 text-sm bg-gray-50 p-2 rounded text-gray-600 border border-gray-100"><i class="fa-solid fa-quote-left text-gray-300 mr-1"></i>${spot.note}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            document.getElementById('food-list').innerHTML = html;
        }

    </script>
</body>
</html>
