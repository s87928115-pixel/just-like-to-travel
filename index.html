<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="滑雪不跌倒">
    
    <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>❄️</text></svg>">
    <link rel="apple-touch-icon" id="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>❄️</text></svg>">
    
    <title>滑雪不跌倒 2025</title>
    
    <!-- 確保 process 物件存在，防止 AI 記帳功能報錯 -->
    <script>
      window.process = { env: { API_KEY: "" } };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#F9F8F6',
                            card: '#FFFFFF',
                            text: '#333333',
                            primary: '#7F6B5D',
                            accent: '#6B8E23',
                            border: '#E0E0D8'
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F9F8F6; -webkit-tap-highlight-color: transparent; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        #loading-screen { position: fixed; inset: 0; background: #F9F8F6; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    </style>

    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom": "https://esm.sh/react-dom@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.475.0",
    "@google/genai": "https://esm.sh/@google/genai@0.2.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="loading-screen">
        <div class="w-12 h-12 border-4 border-muji-primary border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-muji-primary font-bold">程式載入中...</p>
        <p id="error-msg" class="text-red-500 text-xs mt-4 hidden">如果載入過久，請檢查網路或 API 設定</p>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Calendar, Utensils, Wallet, CheckSquare, Info, Snowflake, 
            MapPin, ArrowRight, Plane, Image as ImageIcon, X, Camera, 
            CloudSun, Car, Ticket, Bed, ShoppingBag, Circle, Pencil, 
            Trash, Save, RotateCcw, Sparkles, Loader2, Phone, ThumbsUp, 
            Plus, CheckCircle2, ChevronDown, ChevronUp, Eye, EyeOff, 
            ExternalLink, QrCode, Upload, Edit3, Check, TriangleAlert, BedDouble, Link as LinkIcon
        } from 'lucide-react';
        import { GoogleGenAI, Type } from "@google/genai";

        // --- Helpers ---
        const formatMoney = (num) => new Intl.NumberFormat('en-US').format(num);
        const getMapLink = (query) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
        const processImage = (file, callback) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 600;
                    const scale = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        // --- Data ---
        const ITINERARY_DATA = [
            { day: 1, date: "2/24 (一)", loc: "東京/輕井澤", weather: ["輕井澤"], items: [
                { time: "06:40", title: "酷航 TR898 出發", desc: "第一航廈報到", type: "transport" },
                { time: "10:45", title: "抵達成田機場", desc: "入境、拿行李", type: "transport" },
                { time: "11:13+", title: "搭車至上野", desc: "車程約50分", type: "transport" },
                { time: "15:10", title: "新幹線 -> 輕井澤", desc: "從上野站搭新幹線", type: "transport" },
                { time: "16:30", title: "租雪具", map: "4-8 Karuizawahigashi, Karuizawa, Nagano 389-0104", type: "activity" },
                { time: "住宿", title: "輕井澤王子飯店西館", map: "長野縣北佐久郡輕井澤町輕井澤1016-85", type: "hotel" }
            ]},
            { day: 2, date: "2/25 (二)", loc: "輕井澤", weather: ["輕井澤"], items: [
                { time: "全日", title: "滑雪 Day 1", desc: "小心安全！", type: "activity" }
            ]},
            { day: 3, date: "2/26 (三)", loc: "輕井澤", weather: ["輕井澤"], items: [
                { time: "09:00", title: "滑雪 Day 2", desc: "滑到 16:00 結束", type: "activity" }
            ]},
            { day: 4, date: "2/27 (四)", loc: "輕井澤/東京", weather: ["輕井澤", "東京"], items: [
                { time: "09:30", title: "榆樹街小鎮", desc: "逛街、買伴手禮", type: "shopping" },
                { time: "11:30", title: "舊輕井澤銀座通", desc: "老街逛逛", type: "shopping" },
                { time: "住宿", title: "LANDABOUT TOKYO", map: "東京都, 台東區根岸3-4-5", type: "hotel" }
            ]},
            { day: 5, date: "2/28 (五)", loc: "東京/山形", weather: ["東京", "山形新庄"], items: [
                { time: "10:30", title: "池袋太陽城", type: "shopping" },
                { time: "14:00", title: "新幹線 -> 新庄", type: "transport" },
                { time: "住宿", title: "Route Inn 新莊站前", map: "山形県新庄市金沢沖1109-6", type: "hotel" }
            ]},
            { day: 6, date: "3/1 (六)", loc: "山形/仙台", weather: ["山形新庄", "仙台"], items: [
                { time: "09:00", title: "最上川遊船", type: "activity" },
                { time: "住宿", title: "The OneFive Sendai", map: "4 Chome-6-28 Tsutsujigaoka, Sendai", type: "hotel" }
            ]},
            { day: 7, date: "3/2 (日)", loc: "仙台/山寺", weather: ["仙台"], items: [
                { time: "09:00", title: "前往山寺", type: "transport" },
                { time: "13:00", title: "Costco 富谷倉庫", type: "shopping" }
            ]},
            { day: 8, date: "3/3 (一)", loc: "仙台", weather: ["仙台"], items: [
                { time: "09:30", title: "瑞鳳殿", type: "activity" },
                { time: "18:30", title: "肉十八 燒肉", type: "meal" }
            ]},
            { day: 9, date: "3/4 (二)", loc: "宮城/山形", weather: ["山形市"], items: [
                { time: "10:30", title: "狐狸村", type: "activity" },
                { time: "15:15", title: "藏王樹冰", type: "activity" }
            ]},
            { day: 10, date: "3/5 (三)", loc: "山形/宮城", weather: ["仙台"], items: [
                { time: "10:30", title: "銀山溫泉", type: "activity" },
                { time: "17:30", title: "三井OUTLET 仙台港", type: "shopping" }
            ]},
            { day: 11, date: "3/6 (四)", loc: "仙台/返台", weather: ["仙台"], items: [
                { time: "11:30", title: "AEON MALL 最後採買", type: "shopping" },
                { time: "17:25", title: "星宇 JX863 回程", type: "transport" }
            ]}
        ];

        const PACKING_LIST = [
            { title: "證件錢財", items: ["護照", "信用卡", "現金", "國際駕照", "駕照譯本"] },
            { title: "滑雪準備", items: ["雪鏡", "手套", "厚襪", "暖暖包", "屁墊"] },
            { title: "生活用品", items: ["行動電源", "網卡", "藥品", "保養品"] }
        ];

        const HOTEL_LIST = [
            { name: "輕井澤王子飯店西館", address: "長野縣北佐久郡輕井澤町輕井澤1016-85", note: "Day 1-3" },
            { name: "LANDABOUT TOKYO", address: "東京都, 台東区根岸3-4-5", note: "Day 4" },
            { name: "The OneFive Sendai", address: "仙台市宮城野区榴岡4-6-28", note: "Day 6-10" }
        ];

        // --- Views ---
        const PlanView = ({ coverImg, onUpdateCover }) => {
            const [currentDay, setCurrentDay] = useState(1);
            const selectedDayData = ITINERARY_DATA.find(d => d.day === currentDay);

            const getTypeIcon = (type) => {
                const cls = "text-muji-accent";
                switch(type) {
                    case 'transport': return <Car size={18} className={cls} />;
                    case 'meal': return <Utensils size={18} className={cls} />;
                    case 'activity': return <Snowflake size={18} className={cls} />;
                    case 'hotel': return <Bed size={18} className={cls} />;
                    case 'shopping': return <ShoppingBag size={18} className={cls} />;
                    default: return <Info size={18} className={cls} />;
                }
            };

            return (
                <div className="pt-[130px] pb-24 px-4 animate-fade-in">
                    <div className="fixed top-[70px] left-0 w-full bg-muji-bg/95 z-40 overflow-x-auto no-scrollbar py-3 px-2 border-b flex items-center shadow-sm">
                        {ITINERARY_DATA.map(d => (
                            <button key={d.day} onClick={() => setCurrentDay(d.day)} 
                                className={`whitespace-nowrap px-5 py-2 rounded-full border transition-all mr-2 ${currentDay === d.day ? 'bg-muji-primary text-white border-muji-primary font-bold shadow-md' : 'bg-white border-muji-border text-gray-600'}`}>
                                Day {d.day}
                            </button>
                        ))}
                    </div>

                    <div className="relative mb-6">
                        {coverImg ? (
                            <div className="relative group overflow-hidden rounded-2xl shadow-md border">
                                <img src={coverImg} className="w-full h-48 sm:h-64 object-cover" />
                                <button onClick={() => onUpdateCover(null)} className="absolute top-3 right-3 bg-black/50 text-white p-2 rounded-full"><X size={16} /></button>
                            </div>
                        ) : (
                            <label className="w-full h-40 bg-white border-2 border-dashed border-gray-300 rounded-2xl flex flex-col items-center justify-center text-gray-400 cursor-pointer">
                                <ImageIcon size={24} className="mb-2" />
                                <span className="font-bold text-sm">點擊上傳封面照</span>
                                <input type="file" accept="image/*" className="hidden" onChange={e => e.target.files[0] && processImage(e.target.files[0], onUpdateCover)} />
                            </label>
                        )}
                    </div>

                    {selectedDayData && (
                        <div className="space-y-8 ml-4 border-l-4 border-muji-border">
                            {selectedDayData.items.map((item, idx) => (
                                <div key={idx} className="relative pl-8">
                                    <div className="absolute -left-[20px] top-2 w-10 h-10 rounded-full bg-muji-bg border-2 border-muji-border flex items-center justify-center shadow-sm">
                                        {getTypeIcon(item.type)}
                                    </div>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 transition-all hover:scale-[1.02] hover:shadow-lg">
                                        <div className="text-muji-accent font-bold text-lg">{item.time}</div>
                                        <div className="font-bold text-xl text-muji-text mb-1 pr-10">{item.title}</div>
                                        {item.desc && <div className="text-gray-500 text-base">{item.desc}</div>}
                                        {item.map && <a href={getMapLink(item.map)} target="_blank" className="absolute top-4 right-4 bg-muji-bg p-2 rounded-full text-muji-primary shadow-sm"><MapPin size={20} /></a>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const WalletView = () => {
            const [rate, setRate] = useState(0.22);
            const [records, setRecords] = useState([]);
            const [item, setItem] = useState('');
            const [amount, setAmount] = useState('');
            const [isScanning, setIsScanning] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem('walletRecords');
                if (saved) setRecords(JSON.parse(saved));
            }, []);

            const saveRecord = () => {
                if (!item || !amount) return;
                const newRec = { id: Date.now().toString(), item, amount: parseFloat(amount), date: new Date().toISOString() };
                const updated = [...records, newRec];
                setRecords(updated);
                localStorage.setItem('walletRecords', JSON.stringify(updated));
                setItem(''); setAmount('');
            };

            const total = records.reduce((acc, cur) => acc + cur.amount, 0);

            return (
                <div className="pt-24 pb-24 px-4 space-y-6 animate-fade-in">
                    <div className="bg-white p-5 rounded-2xl border shadow-sm flex justify-between items-center">
                        <span className="font-bold text-muji-primary">匯率 1 JPY = </span>
                        <input type="number" value={rate} onChange={e => setRate(e.target.value)} className="w-20 border-2 rounded p-1 text-center font-bold" />
                    </div>

                    <div className="bg-white rounded-2xl p-6 shadow-sm border">
                        <h3 className="font-bold text-xl mb-4 text-muji-primary">記帳</h3>
                        <input value={item} onChange={e => setItem(e.target.value)} placeholder="品項" className="w-full border-2 rounded-lg p-3 mb-3" />
                        <input type="number" value={amount} onChange={e => setAmount(e.target.value)} placeholder="日幣金額" className="w-full border-2 rounded-lg p-3 mb-4" />
                        <button onClick={saveRecord} className="w-full bg-muji-primary text-white py-3 rounded-xl font-bold">儲存</button>
                    </div>

                    <div className="space-y-4">
                        {[...records].reverse().map(rec => (
                            <div key={rec.id} className="p-4 bg-white rounded-xl border flex justify-between items-center shadow-sm">
                                <div>
                                    <div className="font-bold">{rec.item}</div>
                                    <div className="text-xs text-gray-400">{new Date(rec.date).toLocaleDateString()}</div>
                                </div>
                                <div className="text-right">
                                    <div className="font-bold">¥{formatMoney(rec.amount)}</div>
                                    <div className="text-xs text-muji-accent">≈ NT${formatMoney(Math.round(rec.amount * rate))}</div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="bg-muji-primary text-white p-5 rounded-2xl flex justify-between items-center">
                        <span className="font-bold text-lg">總支出</span>
                        <div className="text-right">
                            <div className="text-2xl font-bold">¥{formatMoney(total)}</div>
                            <div className="text-sm opacity-80">≈ NT${formatMoney(Math.round(total * rate))}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const ListsView = () => {
            const [checks, setChecks] = useState({});
            useEffect(() => {
                const s = localStorage.getItem('checks');
                if (s) setChecks(JSON.parse(s));
            }, []);

            const toggle = (i) => {
                const n = { ...checks, [i]: !checks[i] };
                setChecks(n);
                localStorage.setItem('checks', JSON.stringify(n));
            };

            return (
                <div className="pt-24 pb-24 px-4 animate-fade-in space-y-4">
                    {PACKING_LIST.map(cat => (
                        <div key={cat.title} className="bg-white p-5 rounded-2xl border shadow-sm">
                            <h3 className="font-bold text-muji-primary mb-3 border-b pb-2">{cat.title}</h3>
                            <div className="space-y-2">
                                {cat.items.map(item => (
                                    <label key={item} className="flex items-center gap-3 p-2 rounded-lg">
                                        <input type="checkbox" checked={!!checks[item]} onChange={() => toggle(item)} className="w-5 h-5 rounded" />
                                        <span className={`text-lg ${checks[item] ? 'line-through text-gray-300' : ''}`}>{item}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const InfoView = () => (
            <div className="pt-24 pb-24 px-4 space-y-6 animate-fade-in">
                <div className="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 className="font-bold text-xl text-muji-primary mb-4 flex items-center gap-2"><BedDouble /> 住宿清單</h3>
                    <div className="space-y-4">
                        {HOTEL_LIST.map((h, i) => (
                            <div key={i} className="border-b last:border-0 pb-3">
                                <div className="font-bold text-lg">{h.name}</div>
                                <div className="text-gray-500 text-sm flex items-center gap-1"><MapPin size={14}/>{h.address}</div>
                                <div className="text-xs text-muji-accent mt-1">{h.note}</div>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="bg-red-50 p-6 border-l-4 border-red-400 rounded-2xl shadow-sm">
                    <h3 className="font-bold text-xl text-red-800 mb-2">緊急電話</h3>
                    <div className="flex justify-between font-mono text-xl"><span>警察局</span><span className="font-bold">110</span></div>
                    <div className="flex justify-between font-mono text-xl"><span>救護車</span><span className="font-bold">119</span></div>
                </div>
            </div>
        );

        const App = () => {
            const [tab, setTab] = useState('plan');
            const [cover, setCover] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem('planCoverImg');
                if (saved) setCover(saved);
                
                // 隱藏載入畫面
                const loader = document.getElementById('loading-screen');
                if (loader) loader.style.display = 'none';
            }, []);

            const renderContent = () => {
                switch(tab) {
                    case 'plan': return <PlanView coverImg={cover} onUpdateCover={setCover} />;
                    case 'wallet': return <WalletView />;
                    case 'lists': return <ListsView />;
                    case 'info': return <InfoView />;
                    default: return <PlanView coverImg={cover} onUpdateCover={setCover} />;
                }
            };

            const NavBtn = ({ t, i, l }) => (
                <button onClick={() => { setTab(t); window.scrollTo(0, 0); }} className={`flex flex-col items-center justify-center w-full py-2 transition-colors ${tab === t ? 'text-muji-primary' : 'text-gray-400'}`}>
                    {React.createElement(i, { size: 24, strokeWidth: tab === t ? 2.5 : 2 })}
                    <span className="text-[10px] mt-1">{l}</span>
                </button>
            );

            return (
                <div className="min-h-screen bg-muji-bg">
                    <header className="fixed top-0 w-full bg-muji-bg/95 backdrop-blur-sm z-50 border-b h-[70px] flex justify-between items-center px-4 shadow-sm">
                        <h1 className="text-xl font-bold tracking-widest text-muji-primary flex items-center gap-2">
                            <Snowflake className="text-muji-primary" /> 滑雪不跌倒
                        </h1>
                        <span className="text-xs text-gray-400 font-mono">{new Date().toLocaleDateString()}</span>
                    </header>
                    <main>{renderContent()}</main>
                    <nav className="fixed bottom-0 w-full bg-white border-t z-50 pb-[env(safe-area-inset-bottom)]">
                        <div className="flex justify-around h-[65px]">
                            <NavBtn t="plan" i={Calendar} l="行程" />
                            <NavBtn t="wallet" i={Wallet} l="記帳" />
                            <NavBtn t="lists" i={CheckSquare} l="清單" />
                            <NavBtn t="info" i={Info} l="資訊" />
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script>
      // 輔助檢測：如果 5 秒後還沒載入，顯示錯誤提示
      setTimeout(() => {
        const loader = document.getElementById('loading-screen');
        if (loader && loader.style.display !== 'none') {
          document.getElementById('error-msg').classList.remove('hidden');
        }
      }, 5000);
    </script>
</body>
</html>
